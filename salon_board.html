<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>サロン業務システム - サロンボード連携</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="common.js" defer></script>
    <style>
        .store-checkbox-group {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="header-placeholder"></div>

    <main>
        <div class="container-fluid">
            <h2 class="mb-4" style="font-weight: 600;">サロンボード連携</h2>
            
            <!-- タブナビゲーション -->
            <ul class="nav nav-tabs mb-4" id="salonBoardTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="blog-tab" data-bs-toggle="tab" data-bs-target="#blog" type="button" role="tab">ブログ一括投稿</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="menu-tab" data-bs-toggle="tab" data-bs-target="#menu" type="button" role="tab">メニュー一括編集</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">連携アカウント設定</button>
                </li>
            </ul>

            <!-- タブコンテンツ -->
            <div class="tab-content" id="salonBoardTabsContent">
                
                <!-- ブログ投稿タブ -->
                <div class="tab-pane fade show active" id="blog" role="tabpanel">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card mb-3 shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title mb-3">記事作成</h5>
                                    <div class="mb-3">
                                        <label for="blogCategory" class="form-label">カテゴリ</label>
                                        <select class="form-select" id="blogCategory">
                                            <option value="">選択してください</option>
                                            <option value="プライベート">プライベート</option>
                                            <option value="サロンのNEWS">サロンのNEWS</option>
                                            <option value="おすすめメニュー">おすすめメニュー</option>
                                            <option value="おすすめデザイン">おすすめデザイン</option>
                                            <option value="ビューティー">ビューティー</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="blogTitle" class="form-label">記事タイトル <span id="titleCount" class="text-muted small" style="font-weight: normal;">0/25</span></label>
                                        <input type="text" class="form-control" id="blogTitle" placeholder="例：今月のおすすめクーポン！">
                                    </div>
                                    <div class="mb-3">
                                        <label for="blogContent" class="form-label">記事本文 <span id="contentCount" class="text-muted small" style="font-weight: normal;">0/1000</span></label>
                                        <textarea class="form-control" id="blogContent" rows="12" placeholder="ブログの内容をここに入力してください..."></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="blogImage" class="form-label">画像アップロード (任意)</label>
                                        <input class="form-control" type="file" id="blogImage">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">公開設定</label>
                                        <div class="d-flex gap-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="publishStatus" id="statusPublish" value="publish" checked>
                                                <label class="form-check-label" for="statusPublish">登録・反映する</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="publishStatus" id="statusDraft" value="draft">
                                                <label class="form-check-label" for="statusDraft">登録・未反映にする</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card mb-3 shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title mb-3">対象店舗を選択</h5>
                                    <div class="store-checkbox-group mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="storeAll" onchange="toggleAllStores(this)">
                                            <label class="form-check-label fw-bold" for="storeAll">全店舗</label>
                                        </div>
                                        <hr class="my-2">
                                        <!-- 店舗リスト -->
                                        <div id="blogStoreList"></div>
                                    </div>
                                    <button id="submitBlogButton" class="btn btn-primary w-100 py-2" onclick="submitBlog()"><span class="spinner"></span><span>投稿を実行する</span></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- メニュー編集タブ -->
                <div class="tab-pane fade" id="menu" role="tabpanel"><div class="card"><div class="card-body">メニュー編集機能は開発中です。</div></div></div>
                
                <!-- 設定タブ -->
                <div class="tab-pane fade" id="settings" role="tabpanel">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title m-0">連携店舗一覧</h5>
                                <button class="btn btn-success btn-sm" onclick="openStoreModal()">＋ 店舗を追加</button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>店舗名</th>
                                            <th>ID (システム用)</th>
                                            <th>サロンボードID</th>
                                            <th>スタッフ名</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="storeSettingsTableBody">
                                        <!-- JSで生成 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 店舗追加・編集モーダル -->
    <div class="modal fade" id="storeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="storeModalLabel">店舗設定</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="storeForm">
                        <input type="hidden" id="editIndex">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="storeName" class="form-label">店舗名 <span class="badge bg-danger">必須</span></label>
                                <input type="text" class="form-control" id="storeName" placeholder="例：渋谷店" required>
                            </div>
                            <div class="col-md-6">
                                <label for="storeId" class="form-label">ID (システム用・英数字) <span class="badge bg-danger">必須</span></label>
                                <input type="text" class="form-control" id="storeId" placeholder="例：shibuya" required>
                            </div>
                            <div class="col-md-6">
                                <label for="sbId" class="form-label">サロンボードID <span class="badge bg-danger">必須</span></label>
                                <input type="text" class="form-control" id="sbId" required>
                            </div>
                            <div class="col-md-6">
                                <label for="sbPassword" class="form-label">サロンボードパスワード <span class="badge bg-danger">必須</span></label>
                                <input type="password" class="form-control" id="sbPassword" required>
                            </div>
                            <div class="col-12">
                                <label for="staffName" class="form-label">投稿スタッフ名</label>
                                <input type="text" class="form-control" id="staffName" placeholder="サロンボード上の表示名と完全一致させてください">
                                <div class="form-text">指定しない場合はデフォルトのスタッフが選択されます。</div>
                            </div>
                            <div class="col-12">
                                <label for="templateText" class="form-label">定型文 (ブログ本文の末尾に追加されます)</label>
                                <textarea class="form-control" id="templateText" rows="4" placeholder="署名や共通の案内などを入力してください"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-primary" onclick="saveStore()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <div id="footer-placeholder"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let storeSettings = { stores: [] };
        const storeModal = new bootstrap.Modal(document.getElementById('storeModal'));

        document.addEventListener('DOMContentLoaded', () => {
            loadStoreSettings();
            setupCharCount('blogTitle', 'titleCount', 25);
            setupCharCount('blogContent', 'contentCount', 1000);
        });

        async function loadStoreSettings() {
            try {
                const response = await fetch('/api/salon-board/settings');
                if (response.ok) {
                    const data = await response.json();
                    if (Array.isArray(data)) {
                        storeSettings = { stores: data };
                    } else {
                        storeSettings = data;
                    }
                    if (!storeSettings.stores) storeSettings.stores = [];
                    renderStoreTable();
                    renderBlogStoreList();
                }
            } catch (e) {
                console.error("設定の読み込みに失敗しました", e);
            }
        }

        function getCharCount(str) {
            let len = 0;
            for (let i = 0; i < str.length; i++) {
                const c = str.charCodeAt(i);
                // 半角文字 (ASCII: 0x00-0x7E, 半角カタカナ: 0xFF61-0xFF9F)
                if ((c >= 0x00 && c <= 0x7E) || (c >= 0xFF61 && c <= 0xFF9F)) {
                    len += 0.5;
                } else {
                    len += 1;
                }
            }
            return len;
        }

        function setupCharCount(inputId, displayId, maxLength) {
            const input = document.getElementById(inputId);
            const display = document.getElementById(displayId);
            if (input && display) {
                const update = () => {
                    const count = getCharCount(input.value);
                    display.textContent = `${count}/${maxLength}`;
                };
                input.addEventListener('input', update);
                update(); // 初期表示の更新
            }
        }

        function renderStoreTable() {
            const tbody = document.getElementById('storeSettingsTableBody');
            tbody.innerHTML = '';
            storeSettings.stores.forEach((store, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${store.name}</td>
                    <td>${store.id}</td>
                    <td>${store.sb_id}</td>
                    <td>${store.staff_name || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="openStoreModal(${index})">編集</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteStore(${index})">削除</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderBlogStoreList() {
            const container = document.getElementById('blogStoreList');
            container.innerHTML = '';
            if (storeSettings.stores.length === 0) {
                container.innerHTML = '<div class="text-muted small p-2">店舗が設定されていません。「連携アカウント設定」タブから店舗を追加してください。</div>';
                return;
            }
            storeSettings.stores.forEach(store => {
                const div = document.createElement('div');
                div.className = 'form-check';
                div.innerHTML = `
                    <input class="form-check-input store-check" type="checkbox" id="blog_store_${store.id}" value="${store.id}">
                    <label class="form-check-label" for="blog_store_${store.id}">${store.name}</label>
                `;
                container.appendChild(div);
            });

            // localStorageから前回の選択状態を復元
            try {
                const lastSelected = JSON.parse(localStorage.getItem('lastSelectedBlogStores') || '[]');
                if (lastSelected.length > 0) {
                    lastSelected.forEach(storeId => {
                        const checkbox = document.getElementById(`blog_store_${storeId}`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
            } catch (e) {
                console.error("Failed to restore store selection:", e);
            }
        }

        function openStoreModal(index = null) {
            document.getElementById('storeForm').reset();
            document.getElementById('editIndex').value = index !== null ? index : '';
            
            if (index !== null) {
                const store = storeSettings.stores[index];
                document.getElementById('storeName').value = store.name;
                document.getElementById('storeId').value = store.id;
                document.getElementById('sbId').value = store.sb_id;
                document.getElementById('sbPassword').value = store.sb_password;
                document.getElementById('staffName').value = store.staff_name || '';
                document.getElementById('templateText').value = store.template_text || '';
                document.getElementById('storeModalLabel').innerText = '店舗編集';
            } else {
                document.getElementById('storeModalLabel').innerText = '店舗追加';
            }
            storeModal.show();
        }

        async function saveStore() {
            const name = document.getElementById('storeName').value;
            const id = document.getElementById('storeId').value;
            const sbId = document.getElementById('sbId').value;
            const sbPassword = document.getElementById('sbPassword').value;
            
            if (!name || !id || !sbId || !sbPassword) {
                alert('必須項目を入力してください');
                return;
            }

            const storeData = {
                name: name,
                id: id,
                sb_id: sbId,
                sb_password: sbPassword,
                staff_name: document.getElementById('staffName').value,
                template_text: document.getElementById('templateText').value
            };

            const index = document.getElementById('editIndex').value;
            if (index !== '') {
                storeSettings.stores[index] = storeData;
            } else {
                // ID重複チェック
                if (storeSettings.stores.some(s => s.id === id)) {
                    alert('このIDは既に使用されています。別のIDを指定してください。');
                    return;
                }
                storeSettings.stores.push(storeData);
            }

            try {
                const response = await fetch('/api/salon-board/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(storeSettings)
                });
                
                if (response.ok) {
                    storeModal.hide();
                    renderStoreTable();
                    renderBlogStoreList();
                    alert('設定を保存しました');
                } else {
                    alert('保存に失敗しました');
                }
            } catch (e) {
                alert('エラーが発生しました: ' + e);
            }
        }

        async function deleteStore(index) {
            if (!confirm('この店舗設定を削除してもよろしいですか？')) return;
            
            storeSettings.stores.splice(index, 1);
            
            try {
                await fetch('/api/salon-board/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(storeSettings)
                });
                renderStoreTable();
                renderBlogStoreList();
            } catch (e) {
                alert('削除に失敗しました: ' + e);
            }
        }

        function toggleAllStores(e){
            document.querySelectorAll(".store-check").forEach(c=>c.checked=e.checked)
        }

        async function submitBlog(){
            const submitButton = document.getElementById('submitBlogButton');
            const title = document.getElementById('blogTitle').value;
            const content = document.getElementById('blogContent').value;
            const category = document.getElementById('blogCategory').value;
            const imageInput = document.getElementById('blogImage');
            const publishStatus = document.querySelector('input[name="publishStatus"]:checked').value;
            
            // チェックされた店舗のID(value)を取得
            const checkedBoxes = document.querySelectorAll('.store-check:checked');
            const storeIds = Array.from(checkedBoxes).map(cb => cb.value).filter(val => val && val.trim() !== '');

            // 選択された店舗IDをlocalStorageに保存
            localStorage.setItem('lastSelectedBlogStores', JSON.stringify(storeIds));

            if (!title || !content || !category) {
                alert("タイトル、本文、カテゴリを入力してください。");
                return;
            }
            if (storeIds.length === 0) {
                alert("対象店舗を選択してください。");
                return;
            }

            if(!confirm(`${storeIds.length}店舗にブログを投稿しますか？`)) return;

            // ボタンをローディング状態にする
            submitButton.disabled = true;
            submitButton.classList.add('loading');
            const originalButtonHtml = submitButton.innerHTML;

            let resultMessage = "";
            let successCount = 0;

            // 直列処理（順番に実行）に変更して、Bot検知を回避
            for (let i = 0; i < storeIds.length; i++) {
                const storeId = storeIds[i];
                
                // 進捗状況をボタンに表示
                submitButton.innerHTML = `<span class="spinner"></span><span>処理中... (${i + 1}/${storeIds.length})</span>`;

                const formData = new FormData();
                formData.append('store_ids', JSON.stringify([storeId]));
                formData.append('title', title);
                formData.append('content', content);
                formData.append('category', category);
                formData.append('publish_status', publishStatus);
                if (imageInput.files.length > 0) {
                    formData.append('image', imageInput.files[0]);
                }

                try {
                    const response = await fetch('/api/post-blog', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    
                    if (response.ok) {
                        if (result.results && result.results.length > 0) {
                            result.results.forEach(r => {
                                resultMessage += `店舗ID: ${r.store_id}\n結果: ${r.status}\nメッセージ: ${r.message}\n\n`;
                                if(r.status === 'success' || r.status === 'OK') successCount++;
                            });
                        } else {
                            resultMessage += `店舗ID: ${storeId}\n結果: ${result.status}\nメッセージ: ${result.message || ''}\n\n`;
                            if(result.status === 'success') successCount++;
                        }
                    } else {
                        resultMessage += `店舗ID: ${storeId}\nエラー: ${result.message || response.statusText}\n\n`;
                    }
                } catch (e) {
                    resultMessage += `店舗ID: ${storeId}\n通信エラー: ${e}\n\n`;
                }
            }

            alert(`処理が完了しました。(成功: ${successCount}/${storeIds.length})\n\n` + resultMessage);
            
            // ボタンの状態を元に戻す
            submitButton.disabled = false;
            submitButton.classList.remove('loading');
            submitButton.innerHTML = originalButtonHtml;
        }
    </script>
</body>
</html>