<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ²è¼‰é †ä½ãƒã‚§ãƒƒã‚«ãƒ¼ - ã‚µãƒ­ãƒ³æ¥­å‹™ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ranking_checker.htmlå›ºæœ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .checker-container { display: flex; flex-direction: column; gap: 15px; }
        .checker-container .form-group { display: flex; flex-direction: column; }
        .checker-container label { font-weight: 500; margin-bottom: 8px; }
        .checker-container input[type="text"] { padding: 10px 12px; border: 1px solid #c8c7cc; border-radius: 8px; font-size: 15px; }
        .checker-container select { padding: 10px 12px; border: 1px solid #c8c7cc; border-radius: 8px; font-size: 15px; background-color: white; }
        .button-primary {
            border: none; border-radius: 8px; padding: 12px 20px; font-size: 16px;
            font-weight: 600; cursor: pointer; transition: background-color 0.2s ease-in-out;
            background-color: #007aff; color: white; align-self: flex-start;
        }
        .button-secondary {
            border: none; border-radius: 8px; padding: 12px 20px; font-size: 16px;
            font-weight: 500; cursor: pointer; transition: background-color 0.2s ease-in-out;
            background-color: #e5e5e7; color: #1c1c1e; align-self: flex-start;
        }
        .button-secondary:hover { background-color: #d1d1d6; }
        .button-primary:disabled { background-color: #c8c7cc; cursor: not-allowed; }
        .result-area {
            margin-top: 20px; padding: 16px; background-color: #f8f9fa;
            border-radius: 8px; min-height: 50px; font-size: 18px;
            font-weight: bold; text-align: center;
        }
        .button-container {
            display: flex; gap: 10px; align-items: center; margin-top: 10px;
        }
        .area-row {
            display: flex;
            gap: 15px;
            align-items: flex-start; /* ä¸Šç«¯ã‚’æƒãˆã‚‹ */
        }
        .area-row .form-group {
            flex: 1; /* åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒšãƒ¼ã‚¹ã‚’å‡ç­‰ã«åˆ†é… */
        }

        /* --- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ --- */
        @media (max-width: 768px) {
            .area-row, .button-container {
                flex-direction: column; /* ç¸¦ç©ã¿ã«å¤‰æ›´ */
                align-items: stretch; /* å¹…ã‚’è¦ªè¦ç´ ã«åˆã‚ã›ã‚‹ */
            }
        }
        /* --- ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .search-type-toggle {
            display: flex;
            gap: 10px;
            flex-wrap: nowrap; /* ãƒœã‚¿ãƒ³ãŒæŠ˜ã‚Šè¿”ã•ãªã„ã‚ˆã†ã«ã™ã‚‹ */
            overflow-x: auto;  /* ã¯ã¿å‡ºã—ãŸå ´åˆã«æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ */
            background-color: #e5e5e7;
            padding: 4px;
            border-radius: 8px;
            width: auto;
        }
        .toggle-button {
            padding: 6px 16px;
            border: none;
            background-color: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            transition: all 0.2s ease-in-out;
        }
        .toggle-button.active {
            background-color: #ffffff;
            color: #007aff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .toggle-button:not(.active):hover {
            background-color: #d1d1d6;
        }
        .schedule-setting-inline {
            border-left: none !important; padding-left: 0 !important; margin-left: 0 !important;
        }
        /* --- ã‚°ãƒ©ãƒ•ä¸¦ã³æ›¿ãˆãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .graph-controls {
            display: flex;
            gap: 5px;
        }
        .graph-controls button {
            background-color: #f0f2f5;
            border: 1px solid #d1d1d6;
            border-radius: 6px;
            padding: 2px 8px;
            cursor: pointer;
            font-size: 16px;
        }
        .graph-controls button.excel-button {
            background-color: #e5e5e7;
            color: #1c1c1e;
            font-size: 13px;
            padding: 4px 10px;
        }

        /* --- å°åˆ·ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        @media print {
            /* ãƒ˜ãƒƒãƒ€ãƒ¼ã€ãƒ•ãƒƒã‚¿ãƒ¼ã€ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º */
            header, #footer-placeholder, #header-nav {
                display: none !important;
            }

            /* å°åˆ·ãƒœã‚¿ãƒ³è‡ªä½“ã‚’éè¡¨ç¤º */
            #printButton {
                display: none !important;
            }

            /* ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ã¨è‡ªå‹•è¨ˆæ¸¬ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚‚éè¡¨ç¤ºã« */
            main > div:first-child, /* ã€Œé †ä½ãƒã‚§ãƒƒã‚«ãƒ¼ã€ã¨å°åˆ·ãƒœã‚¿ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠ */
            .card > h3, /* ã€Œè‡ªå‹•è¨ˆæ¸¬ - å±¥æ­´ã‚°ãƒ©ãƒ•ã€ãªã©ã®å°è¦‹å‡ºã— */
            #noAutoHistoryMessage /* ã€Œå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
             {
                display: none !important;
            }

            /* è¨ˆæ¸¬ã‚¿ã‚¤ãƒ—é¸æŠã€æ‰‹å‹•è¨ˆæ¸¬ãƒ•ã‚©ãƒ¼ãƒ ã€ã‚¿ã‚¹ã‚¯ä¸€è¦§ã€ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ãªã©ä¸è¦ãªUIã‚’éè¡¨ç¤º */
            #searchTypeToggle,
            .card:has(#checkRankButton), /* æ‰‹å‹•è¨ˆæ¸¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
            #autoTaskListToggle,
            #autoTaskListContent,
            #meoTaskCopySection,
            #hpbNormalTaskCopySection, 
            #hpbSpecialTaskCopySection,
            #hpbSpecialTaskCopySection,
            .graph-controls { /* ã‚°ãƒ©ãƒ•ã®ä¸¦ã³æ›¿ãˆãƒœã‚¿ãƒ³ */
                display: none !important;
            }

            /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä½™ç™½ã‚’èª¿æ•´ */
            main {
                padding: 0 !important;
            }

            /* ã‚°ãƒ©ãƒ•ã¨è¡¨ãŒãƒšãƒ¼ã‚¸ã‚’ã¾ãŸã„ã§åˆ†å‰²ã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ */
            .graph-wrapper {
                page-break-inside: avoid;
                border: 1px solid #ddd; /* å°åˆ·æ™‚ã«å¢ƒç•Œç·šãŒè¦‹ãˆã‚‹ã‚ˆã†ã« */
                padding: 15px;
            }
        }

        /* --- ãƒ†ãƒ¼ãƒ–ãƒ«ã®å›ºå®šåˆ—ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .sticky-table-container {
            overflow-x: auto;
            position: relative;
        }
        .sticky-table th:first-child,
        .sticky-table td:first-child {
            position: -webkit-sticky; /* Safariç”¨ */
            position: sticky;
            left: 0;
            z-index: 1;
            background-color: #f8f8f8; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®èƒŒæ™¯è‰²ã«åˆã‚ã›ã‚‹ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ) */
        }

        /* --- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .scrollBtns {
            position: fixed; /* ãƒœã‚¿ãƒ³ã‚’ç”»é¢å†…ã®æŒ‡å®šä½ç½®ã«å›ºå®šè¡¨ç¤ºã™ã‚‹ */
            top: 50%;        /* ç”»é¢ã®ä¸Šç«¯ã‹ã‚‰50%ã®ä½ç½® */
            right: 1.5em;    /* ç”»é¢ã®å³ç«¯ã‹ã‚‰ã®è·é›¢ */
            transform: translateY(-50%); /* Yè»¸æ–¹å‘ã«è‡ªèº«ã®é«˜ã•ã®50%ã ã‘ä¸Šã«ç§»å‹• */
            z-index: 100;    /* ä»–ã®è¦ç´ ã‚ˆã‚Šæ‰‹å‰ã«è¡¨ç¤º */
        }
        .scrollBtns a {
            display: block;
            margin: 4px 0;
            padding: 0.4em 0.3em;
            color: white;
            background-color: rgba(0, 0, 0, 0.5); /* åŠé€æ˜ã®é»’ */
            border-radius: 8px;
            opacity: 0.7;
            line-height: 1.1;
            text-decoration: none;
            text-align: center;
            transition: opacity 0.2s ease-in-out, background-color 0.2s ease-in-out;
        }
        .scrollBtns a:hover {
            opacity: 1.0;
            background-color: #007aff; /* ãƒ›ãƒãƒ¼æ™‚ã«ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã« */
        }
        .scrollBtns .arrow  {
            display: block;
            font-size: 1.3em;
        }
        .scrollBtns .label {
            display: block;
            font-size: 0.6em;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="common.js" defer></script>
</head>
<body>
    <header>
        <div class="header-title">
            <h1>ã‚µãƒ­ãƒ³æ¥­å‹™ã‚·ã‚¹ãƒ†ãƒ </h1>
        </div>
        <nav id="header-nav"> <!-- ã“ã®navã‚’ã‚¿ã‚¤ãƒˆãƒ«ã®å³ã«é…ç½®ã—ãŸã„ -->
            <a href="index.html" id="nav-home">ãƒ›ãƒ¼ãƒ </a>
            <a href="ranking_checker.html" id="nav-ranking">é †ä½è¨ˆæ¸¬</a>
            <a href="customer_search.html" id="nav-search">é¡§å®¢æ¤œç´¢</a>
            <a href="#" id="nav-new-carte">æ–°è¦ã‚«ãƒ«ãƒ†ä½œæˆ</a>
            <a href="#" id="nav-reservation">äºˆç´„ç¢ºèª</a>
            <a href="#" id="nav-settings">è¨­å®š</a>
        </nav>
    </header>

    <main>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h2 style="font-weight: 600; margin: 0;">é †ä½ãƒã‚§ãƒƒã‚«ãƒ¼</h2>
            <div style="display: flex; gap: 8px;">
                <button type="button" id="printButton" class="button-secondary" style="padding: 6px 12px; font-size: 14px;">ğŸ–¨ï¸ å°åˆ·</button>
                <button type="button" id="scrollToManualCheckButton" class="button-secondary" style="padding: 6px 12px; font-size: 14px;">æ‰‹å‹•è¨ˆæ¸¬ã¸ç§»å‹•</button>
                <button type="button" id="modeHelpButton" class="button-secondary" style="padding: 6px 12px; font-size: 14px;">ãƒ¢ãƒ¼ãƒ‰èª¬æ˜</button>
            </div>
        </div>

        <!-- è¨ˆæ¸¬ã‚¿ã‚¤ãƒ—é¸æŠUI -->
        <div id="searchTypeToggle" class="search-type-toggle" style="margin-bottom: 16px;">
            <button type="button" class="toggle-button active" data-type="normal">HPB é€šå¸¸</button>
            <button type="button" class="toggle-button" data-type="special">HPB ç‰¹é›†</button>
            <button type="button" class="toggle-button" data-type="google">MEO</button>
        </div>

        <!-- è‡ªå‹•è¨ˆæ¸¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="card">
            <h3 style="margin-top: 0; margin-bottom: 10px; font-size: 18px; font-weight: 600;">è‡ªå‹•è¨ˆæ¸¬ - å±¥æ­´ã‚°ãƒ©ãƒ•</h3>
            <div id="autoHistoryContainer" style="display: none;">
                <div id="autoHistoryGraphs">
                    <!-- è‡ªå‹•è¨ˆæ¸¬ã‚°ãƒ©ãƒ•ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                </div>
            </div>
            <p id="noAutoHistoryMessage">è‡ªå‹•è¨ˆæ¸¬ã®å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>

            <div id="autoTaskListToggle" style="cursor: pointer; user-select: none; margin-top: 20px; padding-bottom: 10px; border-bottom: 1px solid #e5e5e7;">
                <div style="display: flex; justify-content: space-between; align-items: center;" title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’é–‹é–‰">
                    <h4 style="margin: 0; font-size: 18px; font-weight: 600;">è‡ªå‹•è¨ˆæ¸¬ã‚¿ã‚¹ã‚¯ä¸€è¦§</h4>
                    <span id="taskListToggleIcon" style="font-weight: bold; transition: transform 0.2s;">â–¼</span>
                </div>
            </div>
            <div id="autoTaskListContent" style="display: none; padding-top: 10px;">
                <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 10px;">
                    <button type="button" id="manualTriggerButton" class="button-secondary" style="padding: 4px 10px; font-size: 13px;">é¸æŠã—ãŸã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œ</button>
                </div>
                <div id="autoTaskListContainer">
                    <div id="selectAllContainer" style="padding-bottom: 10px; border-bottom: 1px solid #ddd; margin-bottom: 5px; display: none;">
                        <input type="checkbox" id="selectAllTasks">
                        <label for="selectAllTasks" style="font-weight: 500; margin-left: 5px; cursor: pointer;">ã™ã¹ã¦é¸æŠ</label>
                    </div>
                    <ul id="autoTaskList" style="list-style: none; padding: 0;"></ul>
                </div>
            </div>
        </div>

        <!-- æ‰‹å‹•è¨ˆæ¸¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="card" id="manualCheckSection">
            <h3>æ‰‹å‹•è¨ˆæ¸¬ãƒ»ã‚¿ã‚¹ã‚¯è¿½åŠ </h3>
            <div class="checker-container">
                <div class="form-group">
                    <label for="salonNameInput">è‡ªåº—ã®ã‚µãƒ­ãƒ³åï¼ˆæ­£å¼åç§°ã®ä¸€éƒ¨ã§OKï¼‰</label>
                    <input type="text" id="salonNameInput" placeholder="ä¾‹: ã‚±ã‚¤ãƒˆã‚¹ãƒ†ãƒ¼ã‚¸ãƒ©ãƒƒã‚·ãƒ¥åºƒå³¶å…«ä¸å €åº—">
                </div>

                <!-- é€šå¸¸æ¤œç´¢ç”¨ã®å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div id="normalSearchInputs">
                    <div class="area-row">
                        <div class="form-group">
                            <label for="largeAreaSelect">ã‚¨ãƒªã‚¢ãƒ–ãƒ­ãƒƒã‚¯</label>
                            <select id="largeAreaSelect">
                                <option value="" selected>ãƒ–ãƒ­ãƒƒã‚¯ã‚’é¸æŠ</option>
                                <!-- JSã§å‹•çš„ã«ç”Ÿæˆ -->
                            </select>
                        </div>
                        <div class="form-group" id="middleAreaGroup" style="visibility: hidden;">
                            <label for="middleAreaSelect">ä¸­ã‚¨ãƒªã‚¢</label>
                            <select id="middleAreaSelect">
                                <option value="">ãƒ–ãƒ­ãƒƒã‚¯å…¨åŸŸ</option>
                                <!-- JSã§å‹•çš„ã«ç”Ÿæˆ -->
                            </select>
                        </div>
                        <div class="form-group" id="smallAreaGroup" style="visibility: hidden;">
                            <label for="smallAreaSelect">å°ã‚¨ãƒªã‚¢</label>
                            <select id="smallAreaSelect">
                                <option value="">ã‚¨ãƒªã‚¢å…¨åŸŸ</option>
                                <!-- JSã§å‹•çš„ã«ç”Ÿæˆ -->
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="keywordInput">æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚µãƒ¼ãƒ“ã‚¹åãªã©ï¼‰</label>
                        <input type="text" id="keywordInput" placeholder="ä¾‹: ã¾ã¤ã’ãƒ‘ãƒ¼ãƒ ãƒ‘ãƒªã‚¸ã‚§ãƒ³ãƒŒ">
                        <small style="margin-top: 5px; color: #6c6c70;">è¤‡æ•°ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ã‚¹ãƒšãƒ¼ã‚¹ã¾ãŸã¯ã‚«ãƒ³ãƒï¼ˆ,ï¼‰ã§åŒºåˆ‡ã£ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</small>
                    </div>
                </div>

                <!-- ç‰¹é›†ãƒšãƒ¼ã‚¸æ¤œç´¢ç”¨ã®å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div id="specialSearchInputs" style="display: none;">
                    <label for="featurePageUrlInput">ç‰¹é›†ãƒšãƒ¼ã‚¸ã®URL</label>
                    <input type="text" id="featurePageUrlInput" placeholder="ä¾‹: https://beauty.hotpepper.jp/genre/kgkw038/pre34/city20700000/">
                    <small style="margin-top: 5px; color: #6c6c70;">é †ä½ã‚’è¨ˆæ¸¬ã—ãŸã„ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ¼ã®ç‰¹é›†ãƒšãƒ¼ã‚¸ã®URLã‚’è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚</small>
                </div>

                <!-- MEOæ¤œç´¢ç”¨ã®å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div id="googleMapSearchInputs" style="display: none;">
                    <div class="form-group">
                        <label for="searchLocationInput">æ¤œç´¢åœ°ç‚¹ï¼ˆä¾‹: åºƒå³¶é§…, ç¦å±±é§…ï¼‰</label>
                        <input type="text" id="searchLocationInput" placeholder="é †ä½ã‚’çŸ¥ã‚ŠãŸã„æ¤œç´¢ã®åŸºç‚¹ã‚’å…¥åŠ›">
                    </div>
                    <div class="form-group">
                        <label for="googleKeywordInput">æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä¾‹: ã¾ã¤ã’ãƒ‘ãƒ¼ãƒ, çœ‰æ¯›ã‚µãƒ­ãƒ³ï¼‰</label>
                        <input type="text" id="googleKeywordInput" placeholder="Googleãƒãƒƒãƒ—ã§æ¤œç´¢ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
                    </div>
                </div>

                <div class="button-container">
                    <button type="button" id="checkRankButton" class="button-primary">é †ä½ã‚’è¨ˆæ¸¬</button>
                    <button type="button" id="addAutoTaskButton" class="button-secondary">è‡ªå‹•è¨ˆæ¸¬ã«è¿½åŠ </button>
                    <div class="schedule-setting-inline" style="display: flex; align-items: center; gap: 8px; margin-left: 15px; border-left: 1px solid #ddd; padding-left: 15px;">
                        <label for="scheduleHourSelect" style="font-size: 14px; color: #6c6c70; white-space: nowrap;">è‡ªå‹•è¨ˆæ¸¬: æ¯æ—¥</label>
                        <select id="scheduleHourSelect" style="padding: 4px 8px; font-size: 14px; border-radius: 6px; border: 1px solid #c8c7cc;"></select>
                        <label for="scheduleHourSelect" style="font-size: 14px; color: #6c6c70;">æ™‚</label>
                        <button type="button" id="saveScheduleButton" class="button-secondary" style="padding: 4px 10px; font-size: 13px;">ä¿å­˜</button>
                    </div>
                </div>
                <div style="margin-top: 10px; padding-left: 5px;">
                    <small id="scheduleStatus" style="color: #6c6c70; font-size: 12px; display: block;"></small>
                    <small style="color: #ff3b30; font-size: 12px; display: block;">â€»å®Ÿè¡Œæ™‚é–“ã‚’å¤‰æ›´ã—ãŸå¾Œã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§å®Ÿè¡Œã—ã¦ã„ã‚‹Pythonãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼‰ã®å†èµ·å‹•ãŒå¿…è¦ã§ã™ã€‚</small>
                </div>
            </div>
            <div id="resultArea" class="result-area" style="margin-top: 20px;">
                <p id="initialResultMessage">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ã‚µãƒ­ãƒ³åã‚’å…¥åŠ›ã—ã¦ã€Œé †ä½ã‚’è¨ˆæ¸¬ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
            </div>
        </div>

        <!-- ã‚¿ã‚¹ã‚¯ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã‚»ã‚¯ã‚·ãƒ§ãƒ³ (æ‰‹å‹•è¨ˆæ¸¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å¤–ã«ç§»å‹•) -->
        <div class="card">
            <!-- MEOã‚¿ã‚¹ã‚¯ä¸€æ‹¬ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ -->
            <div id="meoTaskCopySection" style="display: none;">
                <h4 style="margin-top: 0; margin-bottom: 10px; font-size: 16px; font-weight: 600;">MEOã‚¿ã‚¹ã‚¯ã‚’åˆ¥åœ°ç‚¹ã«ã‚³ãƒ”ãƒ¼</h4>
                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <select id="copySourceLocation" style="padding: 6px 10px; font-size: 14px; border-radius: 6px;"></select>
                    <span style="font-weight: bold;">â†’</span>
                    <input type="text" id="copyDestLocation" placeholder="ã‚³ãƒ”ãƒ¼å…ˆã®æ¤œç´¢åœ°ç‚¹ (ä¾‹: æ± è¢‹é§…)" style="padding: 6px 10px; font-size: 14px; flex-grow: 1;">
                    <button type="button" id="executeCopyButton" class="button-secondary" style="padding: 6px 12px; font-size: 13px;">ã‚³ãƒ”ãƒ¼å®Ÿè¡Œ</button>
                </div>
                <small style="display: block; margin-top: 8px; color: #6c6c70; font-size: 12px;">ã‚³ãƒ”ãƒ¼å…ƒã®æ¤œç´¢åœ°ç‚¹ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å…¨ã¦ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã€æ–°ã—ã„æ¤œç´¢åœ°ç‚¹ã®ã‚¿ã‚¹ã‚¯ã¨ã—ã¦ä¸€æ‹¬ã§è¿½åŠ ã—ã¾ã™ã€‚</small>
            </div>
            <!-- HPBé€šå¸¸ã‚¿ã‚¹ã‚¯ä¸€æ‹¬ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ -->
            <div id="hpbNormalTaskCopySection" style="display: none;">
                <h4 style="margin-top: 0; margin-bottom: 10px; font-size: 16px; font-weight: 600;">HPBé€šå¸¸ã‚¿ã‚¹ã‚¯ã‚’åˆ¥ã‚¨ãƒªã‚¢ã«ã‚³ãƒ”ãƒ¼</h4>
                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <select id="copySourceArea" style="padding: 6px 10px; font-size: 14px; border-radius: 6px;"></select>
                    <span style="font-weight: bold;">â†’</span>
                    <select id="copyDestArea" style="padding: 6px 10px; font-size: 14px; border-radius: 6px; flex-grow: 1;"></select>
                    <button type="button" id="executeHpbNormalCopyButton" class="button-secondary" style="padding: 6px 12px; font-size: 13px;">ã‚³ãƒ”ãƒ¼å®Ÿè¡Œ</button>
                </div>
                <small style="display: block; margin-top: 8px; color: #6c6c70; font-size: 12px;">ã‚³ãƒ”ãƒ¼å…ƒã®ã‚¨ãƒªã‚¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å…¨ã¦ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã€æ–°ã—ã„ã‚¨ãƒªã‚¢ã®ã‚¿ã‚¹ã‚¯ã¨ã—ã¦ä¸€æ‹¬ã§è¿½åŠ ã—ã¾ã™ã€‚</small>
            </div>
            <!-- HPBç‰¹é›†ã‚¿ã‚¹ã‚¯ä¸€æ‹¬ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ -->
            <div id="hpbSpecialTaskCopySection" style="display: none;">
                <h4 style="margin-top: 0; margin-bottom: 10px; font-size: 16px; font-weight: 600;">HPBç‰¹é›†ã‚¿ã‚¹ã‚¯ã‚’åˆ¥ãƒšãƒ¼ã‚¸ã«ã‚³ãƒ”ãƒ¼</h4>
                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <select id="copySourceSpecialPage" style="padding: 6px 10px; font-size: 14px; border-radius: 6px;"></select>
                    <span style="font-weight: bold;">â†’</span>
                    <input type="text" id="copyDestSpecialPageUrl" placeholder="ã‚³ãƒ”ãƒ¼å…ˆã®ç‰¹é›†ãƒšãƒ¼ã‚¸URL" style="padding: 6px 10px; font-size: 14px; flex-grow: 1;">
                    <button type="button" id="executeHpbSpecialCopyButton" class="button-secondary" style="padding: 6px 12px; font-size: 13px;">ã‚³ãƒ”ãƒ¼å®Ÿè¡Œ</button>
                </div>
                <small style="display: block; margin-top: 8px; color: #6c6c70; font-size: 12px;">ã‚³ãƒ”ãƒ¼å…ƒã®ç‰¹é›†ãƒšãƒ¼ã‚¸ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å…¨ã¦ã®ã‚µãƒ­ãƒ³ã‚’ã€æ–°ã—ã„ç‰¹é›†ãƒšãƒ¼ã‚¸ã®ã‚¿ã‚¹ã‚¯ã¨ã—ã¦ä¸€æ‹¬ã§è¿½åŠ ã—ã¾ã™ã€‚</small>
            </div>
        </div>
    </main>

    <!-- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
    <div class="scrollBtns">
        <a href="#" onclick="scrollbtn(0); return false;"><span class="arrow">â–²</span><span class="label">ä¸Šç«¯ã¸</span></a>
        <a href="#" onclick="scrollbtn(document.body.scrollHeight); return false;"><span class="arrow">â–¼</span><span class="label">ä¸‹ç«¯ã¸</span></a>
    </div>

    <div id="footer-placeholder"></div>

    <script>
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ç”¨ã®é–¢æ•°
        function scrollbtn(scpos) {
            window.scrollTo({ top: scpos, left: 0, behavior: 'smooth' });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const largeAreaSelect = document.getElementById('largeAreaSelect');
            const middleAreaGroup = document.getElementById('middleAreaGroup');
            const middleAreaSelect = document.getElementById('middleAreaSelect');
            const smallAreaGroup = document.getElementById('smallAreaGroup');
            const smallAreaSelect = document.getElementById('smallAreaSelect');
            const keywordInput = document.getElementById('keywordInput');
            const salonNameInput = document.getElementById('salonNameInput');
            const checkRankButton = document.getElementById('checkRankButton');
            const resultArea = document.getElementById('resultArea');
            const salonNameFormGroup = document.querySelector('label[for="salonNameInput"]').parentElement;
            const addAutoTaskButton = document.getElementById('addAutoTaskButton');
            const autoTaskList = document.getElementById('autoTaskList');
            const autoHistoryContainer = document.getElementById('autoHistoryContainer');
            const noAutoHistoryMessage = document.getElementById('noAutoHistoryMessage');
            const manualTriggerButton = document.getElementById('manualTriggerButton');
            const selectAllContainer = document.getElementById('selectAllContainer');
            const selectAllCheckbox = document.getElementById('selectAllTasks');
            const scheduleHourSelect = document.getElementById('scheduleHourSelect');
            const saveScheduleButton = document.getElementById('saveScheduleButton');
            const scheduleStatus = document.getElementById('scheduleStatus');
            const autoTaskListToggle = document.getElementById('autoTaskListToggle');
            const autoTaskListContent = document.getElementById('autoTaskListContent');
            const taskListToggleIcon = document.getElementById('taskListToggleIcon');
            const normalSearchInputs = document.getElementById('normalSearchInputs');
            const specialSearchInputs = document.getElementById('specialSearchInputs');
            const googleMapSearchInputs = document.getElementById('googleMapSearchInputs');
            const searchTypeToggle = document.getElementById('searchTypeToggle');
            const meoCopySection = document.getElementById('meoTaskCopySection');
            const hpbNormalTaskCopySection = document.getElementById('hpbNormalTaskCopySection');
            const hpbSpecialTaskCopySection = document.getElementById('hpbSpecialTaskCopySection');
            const printButton = document.getElementById('printButton');
            const modeHelpButton = document.getElementById('modeHelpButton');
            const scrollToManualCheckButton = document.getElementById('scrollToManualCheckButton');





            // ã‚°ãƒ©ãƒ•ã§ä½¿ç”¨ã™ã‚‹è‰²ã®ãƒªã‚¹ãƒˆ
            const CHART_COLORS = [
                '#007aff', '#34c759', '#ff9500', '#ff3b30', '#5856d6', 
                '#ff2d55', '#af52de', '#5ac8fa', '#ffcc00', '#8e8e93',
                '#4cd964', '#ff453a', '#bf5af2', '#a2845e', '#00a0a0',
                '#e58a00', '#0059b3', '#d9006c', '#63a95e', '#a6a6a6'
            ];
            // HPBã®å†…éƒ¨ã‚³ãƒ¼ãƒ‰ã‚’å«ã‚€ã‚¨ãƒªã‚¢ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«å¤‰æ›´
            const areas = {
                "åŒ—æµ·é“": {
                    code: "SD", // ã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒªã‚¢ã‚³ãƒ¼ãƒ‰
                    middleAreas: { "æœ­å¹Œ": { code: "DA", smallAreas: {} }, "æ—­å·": { code: "DB", smallAreas: {} }, "å‡½é¤¨": { code: "DD", smallAreas: {} }, "ãã®ä»–åŒ—æµ·é“": { code: "DC", smallAreas: {} }}
                },
                "æ±åŒ—": {
                    code: "SE",
                    middleAreas: {
                        "ä»™å°ãƒ»å®®åŸ": { code: "EA", smallAreas: {} }, "éƒ¡å±±": { code: "EH", smallAreas: {} }, "ã„ã‚ããƒ»ç¦å³¶ãƒ»ãã®ä»–ç¦å³¶çœŒ": { code: "EG", smallAreas: {} },
                        "å²©æ‰‹ãƒ»ç››å²¡": { code: "EC", smallAreas: {} }, "é’æ£®ãƒ»å…«æˆ¸": { code: "ED", smallAreas: {} }, "å±±å½¢": { code: "EE", smallAreas: {} }, "ç§‹ç”°": { code: "EF", smallAreas: {} }
                    }
                },
                "åŒ—ä¿¡è¶Š": {
                    code: "SH",
                    middleAreas: {
                        "æ–°æ½Ÿ": { code: "HA", smallAreas: {} }, "é•·å²¡": { code: "HB", smallAreas: {} }, "çŸ³å·ãƒ»é‡‘æ²¢": { code: "HC", smallAreas: {} },
                        "é•·é‡": { code: "HD", smallAreas: {} }, "æ¾æœ¬": { code: "HE", smallAreas: {} }, "ãã®ä»–é•·é‡çœŒ": { code: "HH", smallAreas: {} },
                        "å¯Œå±±": { code: "HF", smallAreas: {} }, "ç¦äº•": { code: "HG", smallAreas: {} }
                    }
                },
                "é–¢æ±": {
                    code: "SA",
                    middleAreas: {
                        "æ–°å®¿ãƒ»é«˜ç”°é¦¬å ´ãƒ»ä»£ã€…æœ¨": { code: "AA", smallAreas: {} }, "æ± è¢‹ãƒ»ç›®ç™½": { code: "AB", smallAreas: {} }, "æµæ¯”å¯¿ãƒ»ä»£å®˜å±±ãƒ»ä¸­ç›®é»’ãƒ»åºƒå°¾ãƒ»éº»å¸ƒãƒ»å…­æœ¬æœ¨": { code: "AC", smallAreas: {} },
                        "æ¸‹è°·ãƒ»é’å±±ãƒ»è¡¨å‚é“ãƒ»åŸå®¿": { code: "AD", smallAreas: {} }, "è‡ªç”±ãŒä¸˜ãƒ»å­¦èŠ¸å¤§å­¦ãƒ»æ­¦è”µå°æ‰ãƒ»èŠå": { code: "AE", smallAreas: {} }, "ä¸‰è»’èŒ¶å±‹ãƒ»äºŒå­ç‰å·ãƒ»æºã®å£ãƒ»é’è‘‰å°": { code: "JL", smallAreas: {} },
                        "éŠ€åº§ãƒ»æœ‰æ¥½ç”ºãƒ»æ–°æ©‹ãƒ»ä¸¸ã®å†…ãƒ»æ—¥æœ¬æ©‹": { code: "AF", smallAreas: {} }, "ä¸Šé‡ãƒ»ç¥ç”°ãƒ»åŒ—åƒä½ãƒ»äº€æœ‰ãƒ»é’ç ¥ãƒ»ç”ºå±‹": { code: "AG", smallAreas: {} }, "å“å·ãƒ»ç›®é»’ãƒ»äº”åç”°ãƒ»ç”°ç”º": { code: "AH", smallAreas: {} },
                        "ä¸¡å›½ãƒ»éŒ¦ç³¸ç”ºãƒ»å°å²©ãƒ»æ£®ä¸‹ãƒ»ç‘æ±Ÿ": { code: "JP", smallAreas: {} }, "é–€å‰ä»²ç”ºãƒ»å‹ã©ããƒ»æœˆå³¶ãƒ»è±Šæ´²": { code: "JQ", smallAreas: {} }, "ä¸­é‡ãƒ»é«˜å††å¯ºãƒ»é˜¿ä½ãƒ¶è°·": { code: "AI", smallAreas: {} },
                        "å‰ç¥¥å¯ºãƒ»è»çªªãƒ»è¥¿è»çªªãƒ»ä¸‰é·¹": { code: "AJ", smallAreas: {} }, "å…«ç‹å­ãƒ»ç«‹å·ãƒ»å›½ç«‹ãƒ»å¤šæ‘©ãƒ»æ—¥é‡ãƒ»ç¦ç”Ÿãƒ»ç§‹å·": { code: "AK", smallAreas: {} }, "å±±æ¢¨": { code: "JN", smallAreas: {} },
                        "ç”ºç”°ãƒ»ç›¸æ¨¡å¤§é‡ãƒ»æµ·è€åãƒ»æœ¬åšæœ¨ãƒ»æ©‹æœ¬": { code: "AL", smallAreas: {} }, "å¤§å®®ãƒ»æµ¦å’Œãƒ»å·å£ãƒ»å²©æ§»": { code: "AM", smallAreas: {} }, "åƒè‘‰ãƒ»ç¨²æ¯›ãƒ»å¹•å¼µãƒ»éŒå–ãƒ»éƒ½è³€": { code: "AN", smallAreas: {} },
                        "èˆ¹æ©‹ãƒ»æ´¥ç”°æ²¼ãƒ»æœ¬å…«å¹¡ãƒ»æµ¦å®‰ãƒ»å¸‚å·": { code: "AO", smallAreas: {} }, "æŸãƒ»æ¾æˆ¸ãƒ»æˆ‘å­«å­": { code: "AP", smallAreas: {} }, "æ¨ªæµœãƒ»é–¢å†…ãƒ»å…ƒç”ºãƒ»ä¸Šå¤§å²¡ãƒ»ç™½æ¥½": { code: "AQ", smallAreas: {} },
                        "ã‚»ãƒ³ã‚¿ãƒ¼å—ãƒ»äºŒä¿£å·ãƒ»æˆ¸å¡šãƒ»æ‰ç”°ãƒ»é‡‘æ²¢æ–‡åº«": { code: "JM", smallAreas: {} }, "å¤§äº•ç”ºãƒ»å¤§æ£®ãƒ»è’²ç”°ãƒ»å·å´ãƒ»é¶´è¦‹": { code: "AR", smallAreas: {} }, "æ¹˜å—ãƒ»éŒå€‰ãƒ»é€—å­": { code: "AS", smallAreas: {} },
                        "å®‡éƒ½å®®ãƒ»æ ƒæœ¨": { code: "AT", smallAreas: {} }, "æ°´æˆ¸ãƒ»ã²ãŸã¡ãªã‹ãƒ»æ—¥ç«‹ãƒ»èŒ¨åŸ": { code: "JO", smallAreas: {} }, "æ¨ªé ˆè³€ãƒ»å°ç”°åŸ": { code: "AU", smallAreas: {} },
                        "å¾¡èŒ¶ãƒæ°´ãƒ»å››ãƒ„è°·ãƒ»åƒé§„æœ¨ãƒ»èŒ—è·è°·": { code: "AV", smallAreas: {} }, "é·ºãƒå®®ãƒ»ç”°ç„¡ãƒ»æ±æ‘å±±ãƒ»æ‹å³¶": { code: "AW", smallAreas: {} }, "å¸‚åŸãƒ»æœ¨æ›´æ´¥ãƒ»èŒ‚åŸãƒ»å‹æµ¦ãƒ»æ±é‡‘ãƒ»éŠšå­": { code: "AX", smallAreas: {} },
                        "å–æ‰‹ãƒ»åœŸæµ¦ãƒ»ã¤ãã°ãƒ»é¹¿å¶‹": { code: "AY", smallAreas: {} }, "ä¸Šå°¾ãƒ»ç†Šè°·ãƒ»æœ¬åº„": { code: "AZ", smallAreas: {} }, "æ±å¤§å®®ãƒ»å¤æ²³ãƒ»å°å±±": { code: "JA", smallAreas: {} },
                        "ä¸‹åŒ—æ²¢ãƒ»æˆåŸå­¦åœ’ãƒ»å‘ãƒ¶ä¸˜éŠåœ’ãƒ»æ–°ç™¾åˆãƒ¶ä¸˜": { code: "JB", smallAreas: {} }, "èµ¤ç¾½ãƒ»æ¿æ©‹ãƒ»ç‹å­ãƒ»å·£é´¨": { code: "JC", smallAreas: {} }, "è¥¿æ–°äº•ãƒ»è‰åŠ ãƒ»è¶Šè°·ãƒ»æ˜¥æ—¥éƒ¨ãƒ»ä¹…å–œ": { code: "JD", smallAreas: {} },
                        "å¤§å±±ãƒ»æˆå¢—ãƒ»å¿—æœ¨ãƒ»å·è¶Šãƒ»æ±æ¾å±±": { code: "JE", smallAreas: {} }, "å…«åƒä»£ãƒ»ä½å€‰ãƒ»éŒãƒ¶è°·ãƒ»æˆç”°": { code: "JF", smallAreas: {} }, "æ˜å¤§å‰ãƒ»åƒæ­³çƒå±±ãƒ»èª¿å¸ƒãƒ»åºœä¸­": { code: "JG", smallAreas: {} },
                        "æµå±±ãƒ»ä¸‰éƒ·ãƒ»é‡ç”°": { code: "JH", smallAreas: {} }, "ç·´é¦¬ãƒ»ã²ã°ã‚Šãƒ¶ä¸˜ãƒ»æ‰€æ²¢ãƒ»é£¯èƒ½ãƒ»ç‹­å±±": { code: "JI", smallAreas: {} }, "å‰æ©‹ãƒ»é«˜å´ãƒ»ä¼Šå‹¢å´ãƒ»å¤ªç”°ãƒ»ç¾¤é¦¬": { code: "JK", smallAreas: {} }
                    }
                },
                "æ±æµ·": {
                    code: "SC",
                    middleAreas: {
                        "åé§…ãƒ»æ „ãƒ»é‡‘å±±ãƒ»æœ¬å±±": { code: "CA", smallAreas: {} }, "ä¸€å®®ãƒ»çŠ¬å±±ãƒ»æ±Ÿå—ãƒ»å°ç‰§ãƒ»å°ç”°äº•": { code: "CE", smallAreas: {} }, "æ—¥é€²ãƒ»è±Šç”°ãƒ»åˆˆè°·ãƒ»å²¡å´ãƒ»å®‰åŸãƒ»è±Šæ©‹": { code: "CI", smallAreas: {} },
                        "å²é˜œ": { code: "CB", smallAreas: {} }, "é™å²¡ãƒ»è—¤æãƒ»ç„¼æ´¥ãƒ»å³¶ç”°": { code: "CC", smallAreas: {} }, "æµœæ¾ãƒ»ç£ç”°ãƒ»æ›å·ãƒ»è¢‹äº•": { code: "CD", smallAreas: {} },
                        "æ¡‘åãƒ»å››æ—¥å¸‚ãƒ»æ´¥ãƒ»éˆ´é¹¿ãƒ»ä¼Šå‹¢": { code: "CH", smallAreas: {} }
                    }
                },
                "é–¢è¥¿": {
                    code: "SB",
                    middleAreas: {
                        "æ¢…ç”°ãƒ»äº¬æ©‹ãƒ»ç¦å³¶ãƒ»æœ¬ç”º": {
                            code: "BA",
                            smallAreas: {
                                "æ¢…ç”°ãƒ»è¥¿æ¢…ç”°": { code: "X074" },
                                "èŠç”°ãƒ»èŒ¶å±‹ç”ºãƒ»ä¸­å´ç”º": { code: "X506" },
                                "ç¦å³¶ãƒ»é‡ç”°": { code: "X507" },
                                "å¤©ç¥æ©‹ç­‹": { code: "X508" },
                                "äº¬æ©‹ãƒ»éƒ½å³¶": { code: "X075" },
                                "åŒ—æµœãƒ»è‚¥å¾Œæ©‹ãƒ»æœ¬ç”º": { code: "X509" }
                            }
                        }, "å¿ƒæ–æ©‹ãƒ»é›£æ³¢ãƒ»å¤©ç‹å¯º": { code: "BB", smallAreas: {} }, "èŒ¨æœ¨ãƒ»é«˜æ§»": { code: "BC", smallAreas: {} },
                        "å ºãƒ»å—å¤§é˜ª": { code: "BD", smallAreas: {} }, "äº¬éƒ½": { code: "BE", smallAreas: {} }, "èˆé¶´ãƒ»ç¦çŸ¥å±±ãƒ»äº¬ä¸¹å¾Œ": { code: "BT", smallAreas: {} },
                        "ä¸‰å®®ãƒ»å…ƒç”ºãƒ»ç¥æˆ¸ãƒ»å…µåº«ãƒ»ç˜ãƒ»æ±ç˜": { code: "BF", smallAreas: {} }, "å§«è·¯ãƒ»åŠ å¤å·": { code: "BG", smallAreas: {} }, "é«˜çŸ³ãƒ»åºœä¸­ãƒ»å²¸å’Œç”°ãƒ»æ³‰ä½é‡ãƒ»å’Œæ­Œå±±": { code: "BH", smallAreas: {} },
                        "å·è¥¿ãƒ»å®å¡šãƒ»ä¸‰ç”°ãƒ»è±Šå²¡": { code: "BI", smallAreas: {} }, "æ»‹è³€": { code: "BJ", smallAreas: {} }, "é´«é‡ãƒ»ä½é“ãƒ»å››æ¡ç•·ãƒ»ç·‘æ©‹ãƒ»çŸ³åˆ‡ãƒ»å¸ƒæ–½ãƒ»èŠ±åœ’": { code: "BK", smallAreas: {} },
                        "æ˜­å’Œç”ºãƒ»å¤§æ­£ãƒ»ä½å‰ãƒ»ä½ä¹‹æ±Ÿ": { code: "BL", smallAreas: {} }, "è¥¿å®®ãƒ»ä¼Šä¸¹ãƒ»èŠ¦å±‹ãƒ»å°¼å´": { code: "BM", smallAreas: {} }, "é•·å²¡äº¬ãƒ»ä¼è¦‹ãƒ»å±±ç§‘ãƒ»äº¬ç”°è¾ºãƒ»æœ¨æ´¥ãƒ»äº€å²¡": { code: "BN", smallAreas: {} },
                        "å¥ˆè‰¯": { code: "BO", smallAreas: {} }, "å¹³é‡ãƒ»å…«å°¾ãƒ»æ¾åŸãƒ»å¤å¸‚ãƒ»è—¤äº•å¯ºãƒ»å¯Œç”°æ—": { code: "BP", smallAreas: {} }, "é–€çœŸãƒ»æšæ–¹ãƒ»å¯å±‹å·ãƒ»é–¢ç›®ãƒ»å®ˆå£ãƒ»è’²ç”Ÿãƒ»é¶´è¦‹": { code: "BQ", smallAreas: {} },
                        "ä¸‰æœ¨ãƒ»åŒ—åŒºãƒ»è¥¿åŒºãƒ»é•·ç”°ãƒ»æ˜çŸ³ãƒ»å‚æ°´": { code: "BR", smallAreas: {} }, "æ±Ÿå‚ãƒ»ç·‘åœ°å…¬åœ’ãƒ»åƒé‡Œä¸­å¤®ãƒ»è±Šä¸­ãƒ»æ± ç”°ãƒ»ç®•é¢": { code: "BS", smallAreas: {} }
                    }
                },
                "ä¸­å›½": {
                    code: "SF",
                    middleAreas: { "åºƒå³¶": { code: "FA", smallAreas: {} }, "ç¦å±±ãƒ»å°¾é“": { code: "FC", smallAreas: {} }, "å²¡å±±ãƒ»å€‰æ•·": { code: "FB", smallAreas: {} }, "å±±å£": { code: "FG", smallAreas: {} }, "é³¥å–": { code: "FD", smallAreas: {} }, "å³¶æ ¹": { code: "FE", smallAreas: {} }}
                },
                "å››å›½": {
                    code: "SI",
                    middleAreas: { "æ¾å±±ãƒ»æ„›åª›": { code: "IA", smallAreas: {} }, "é«˜æ¾ãƒ»é¦™å·": { code: "IB", smallAreas: {} }, "é«˜çŸ¥": { code: "IC", smallAreas: {} }, "å¾³å³¶": { code: "ID", smallAreas: {} }}
                },
                "ä¹å·ãƒ»æ²–ç¸„": {
                    code: "SG",
                    middleAreas: {
                        "ç¦å²¡": {
                            code: "GA",
                            smallAreas: {
                                "å¤©ç¥ãƒ»å¤§å": { "code": "X168" },
                                "ä»Šæ³‰ãƒ»è­¦å›ºãƒ»è–¬é™¢": { "code": "X169" },
                                "èµ¤å‚ãƒ»å¤§æ¿ ãƒ»è¥¿æ–°å‘¨è¾º": { "code": "X174" },
                                "åšå¤šé§…å‘¨è¾º": { "code": "X170" },
                                "ä¸­æ´²ãƒ»ä½å‰ãƒ»æ˜¥å‰": { "code": "X171" },
                                "å¹³å°¾ãƒ»é«˜å®®ãƒ»å¤§æ©‹ãƒ»äº•å°»": { "code": "X172" },
                                "æ˜¥æ—¥ãƒ»å¤§é‡åŸãƒ»ç­‘ç´«é‡å‘¨è¾º": { "code": "X348" },
                                "å§ªæµœå‘¨è¾º": { "code": "X349" },
                                "ä¸ƒéšˆæ²¿ç·š": { "code": "X175" },
                                "ç®±å´ãƒ»åƒæ—©ãƒ»é¦™æ¤å‘¨è¾º": { "code": "X350" },
                                "ç³Ÿå±‹ãƒ»æ–°å®®ãƒ»å¤è³€ãƒ»ç¦æ´¥": { "code": "X466" },
                                "å¤§ç‰Ÿç”°ãƒ»æŸ³å·": { "code": "X481" },
                                "é£¯å¡šãƒ»ç”°å·": { "code": "X482" },
                                "å®—åƒãƒ»é è³€": { "code": "X491" },
                                "ç³¸å³¶ãƒ»ãã®ä»–ç¦å²¡ã‚¨ãƒªã‚¢": { "code": "X176" }
                            }
                        }, "åŒ—ä¹å·": { code: "GB", smallAreas: {} }, "ä¹…ç•™ç±³": { code: "GH", smallAreas: {} },
                        "é•·å´": { code: "GD", smallAreas: {} }, "ç†Šæœ¬": { code: "GE", smallAreas: {} }, "å¤§åˆ†": { code: "GF", smallAreas: {} },
                        "å®®å´": { code: "GG", smallAreas: {} }, "é¹¿å…å³¶": { code: "GC", smallAreas: {} }, "ä½è³€": { code: "GJ", smallAreas: {} }, "æ²–ç¸„": { code: "GI", smallAreas: {} }
                    }
                }
            };

            // 1. ã‚¨ãƒªã‚¢ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆå¤§ã‚¨ãƒªã‚¢ï¼‰ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ç”Ÿæˆ
            for (const blockName in areas) {
                const option = document.createElement('option');
                option.value = blockName;
                option.textContent = `${blockName} (${areas[blockName].code})`;
                largeAreaSelect.appendChild(option);
            }

            // 2. ã‚¨ãƒªã‚¢ãƒ–ãƒ­ãƒƒã‚¯ãŒé¸æŠã•ã‚ŒãŸã‚‰ã€ä¸­ã‚¨ãƒªã‚¢ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
            largeAreaSelect.addEventListener('change', () => {
                const selectedLargeArea = largeAreaSelect.value;
                middleAreaSelect.innerHTML = '<option value="">ãƒ–ãƒ­ãƒƒã‚¯å…¨åŸŸ</option>';
                smallAreaSelect.innerHTML = '<option value="">ã‚¨ãƒªã‚¢å…¨åŸŸ</option>';
                middleAreaGroup.style.visibility = 'hidden';
                smallAreaGroup.style.visibility = 'hidden';

                if (selectedLargeArea && areas[selectedLargeArea]) {
                    for (const middleAreaName in areas[selectedLargeArea].middleAreas) {
                        const option = document.createElement('option');
                        option.value = middleAreaName;
                        const middleAreaCode = areas[selectedLargeArea].middleAreas[middleAreaName].code;
                        option.textContent = `${middleAreaName} (${middleAreaCode})`;
                        middleAreaSelect.appendChild(option);
                    }
                    middleAreaGroup.style.visibility = 'visible';
                }
            });

            // 3. ä¸­ã‚¨ãƒªã‚¢ãŒé¸æŠã•ã‚ŒãŸã‚‰ã€å°ã‚¨ãƒªã‚¢ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
            middleAreaSelect.addEventListener('change', () => {
                const selectedLargeArea = largeAreaSelect.value;
                const selectedMiddleArea = middleAreaSelect.value;
                smallAreaSelect.innerHTML = '<option value="">ã‚¨ãƒªã‚¢å…¨åŸŸ</option>';
                smallAreaGroup.style.visibility = 'hidden';

                // 3éšå±¤ç›®ã®ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã€ç©ºã®é…åˆ—ã§ãªã„å ´åˆã®ã¿å°ã‚¨ãƒªã‚¢ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’è¡¨ç¤º
                const smallAreaDefs = areas[selectedLargeArea]?.middleAreas[selectedMiddleArea]?.smallAreas;
                if (smallAreaDefs && Object.keys(smallAreaDefs).length > 0) {

                    for (const smallAreaName in smallAreaDefs) {
                        const option = document.createElement('option');
                        option.value = smallAreaName;
                        const smallAreaCode = smallAreaDefs[smallAreaName].code;
                        option.textContent = `${smallAreaName} (${smallAreaCode})`;
                        smallAreaSelect.appendChild(option);
                    }
                    smallAreaGroup.style.visibility = 'visible';
                }
            });

            // --- è¨ˆæ¸¬ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆ ---
            searchTypeToggle.addEventListener('click', (event) => {
                const clickedButton = event.target.closest('.toggle-button');
                if (!clickedButton) return;

                // ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã‹ã‚‰activeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
                searchTypeToggle.querySelectorAll('.toggle-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã«activeã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                clickedButton.classList.add('active');

                // --- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ ---
                normalSearchInputs.style.display = 'none';
                specialSearchInputs.style.display = 'none';
                googleMapSearchInputs.style.display = 'none';
                // SEOä»¥å¤–ã§ã¯ã‚µãƒ­ãƒ³åå…¥åŠ›æ¬„ã‚’è¡¨ç¤º
                salonNameFormGroup.style.display = 'block';

                if (clickedButton.dataset.type === 'normal') {
                    normalSearchInputs.style.display = 'block';
                } else if (clickedButton.dataset.type === 'special') {
                    specialSearchInputs.style.display = 'block';
                } else if (clickedButton.dataset.type === 'google') {
                    googleMapSearchInputs.style.display = 'block';
                }

                // ã‚°ãƒ©ãƒ•ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ãŸã‚ã«å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿ãƒ»å†æç”»ã™ã‚‹
                // MEOã®å±¥æ­´æ©Ÿèƒ½ã¯ä»Šå¾Œã®æ‹¡å¼µã§å¯¾å¿œ
                fetchAndDisplayAutoHistory();

                // --- ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ ---
                meoCopySection.style.display = 'none';
                hpbNormalTaskCopySection.style.display = 'none';
                hpbSpecialTaskCopySection.style.display = 'none';

                if (clickedButton.dataset.type === 'google') {
                    meoCopySection.style.display = 'block';
                    updateCopySourceLocations();
                } else if (clickedButton.dataset.type === 'normal') {
                    hpbNormalTaskCopySection.style.display = 'block';
                    updateHpbNormalCopySources();
                } else if (clickedButton.dataset.type === 'special') {
                    hpbSpecialTaskCopySection.style.display = 'block';
                    updateHpbSpecialCopySources();
                }

                renderAutoTasks();
            });
            
            // ãƒ¢ãƒ¼ãƒ‰èª¬æ˜ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            modeHelpButton.addEventListener('click', () => {
                const activeMode = searchTypeToggle.querySelector('.toggle-button.active').dataset.type;
                let helpText = '';

                if (activeMode === 'normal') {
                    helpText = `â–  HPBé€šå¸¸æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ã«ã¤ã„ã¦

ã“ã®ãƒ¢ãƒ¼ãƒ‰ã¯ã€ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ¼ã®é€šå¸¸ã®æ¤œç´¢çµæœãƒšãƒ¼ã‚¸ã§ã®æ²è¼‰é †ä½ã‚’è¨ˆæ¸¬ã—ã¾ã™ã€‚

ã€è¨ˆæ¸¬æ–¹æ³•ã€‘
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä¾‹ï¼šã€Œã¾ã¤ã’ãƒ‘ãƒ¼ãƒã€ï¼‰ã¨ã‚¨ãƒªã‚¢ï¼ˆä¾‹ï¼šã€Œç¦å±±ãƒ»å°¾é“ã€ï¼‰ã‚’æŒ‡å®šã—ã¦æ¤œç´¢ã—ãŸéš›ã®çµæœã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã¾ã™ã€‚

ã€ç”¨é€”ã€‘
ç‰¹å®šã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ã‚¨ãƒªã‚¢ã®çµ„ã¿åˆã‚ã›ã«ãŠã‘ã‚‹ã€è‡ªåº—ã®ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯ãªæ¤œç´¢é †ä½ã‚’ç¢ºèªã—ãŸã„å ´åˆã«ä½¿ç”¨ã—ã¾ã™ã€‚`;
                } else if (activeMode === 'special') {
                    helpText = `â–  HPBç‰¹é›†æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ã«ã¤ã„ã¦

ã“ã®ãƒ¢ãƒ¼ãƒ‰ã¯ã€ã€Œã€‡ã€‡é§…ã§äººæ°—ã®ã‚µãƒ­ãƒ³ç‰¹é›†ã€ã®ã‚ˆã†ãªã€ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ¼ãŒç‹¬è‡ªã«ç·¨é›†ã—ãŸã€Œç‰¹é›†ãƒšãƒ¼ã‚¸ã€ã§ã®æ²è¼‰é †ä½ã‚’è¨ˆæ¸¬ã—ã¾ã™ã€‚

ã€è¨ˆæ¸¬æ–¹æ³•ã€‘
æŒ‡å®šã•ã‚ŒãŸç‰¹é›†ãƒšãƒ¼ã‚¸ã®URLã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ãã®ãƒšãƒ¼ã‚¸å†…ã§ã®ã‚µãƒ­ãƒ³ã®æ²è¼‰é †ä½ã‚’ç¢ºèªã—ã¾ã™ã€‚

ã€ç”¨é€”ã€‘
HPBã®ç‰¹é›†ä¼ç”»ã«æ²è¼‰ã•ã‚Œã¦ã„ã‚‹å ´åˆã®é †ä½ã‚’ç¢ºèªã—ãŸã„å ´åˆã«ä½¿ç”¨ã—ã¾ã™ã€‚ä»£ç†åº—æ§˜ãªã©ãŒã€ŒLPï¼ˆãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ï¼‰ã€ã¨å‘¼ã¶ãƒšãƒ¼ã‚¸ã‚‚ã€å¤šãã¯ã“ã®ç‰¹é›†ãƒšãƒ¼ã‚¸ã«è©²å½“ã—ã¾ã™ã€‚`;
                } else if (activeMode === 'google') {
                    helpText = `â–  MEOæ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ã«ã¤ã„ã¦

ã“ã®ãƒ¢ãƒ¼ãƒ‰ã¯ã€Googleãƒãƒƒãƒ—ã§ã®æ¤œç´¢çµæœï¼ˆMEOï¼‰ã«ãŠã‘ã‚‹æ²è¼‰é †ä½ã‚’è¨ˆæ¸¬ã—ã¾ã™ã€‚

ã€ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã®æ’é™¤ã€‘
Googleãƒãƒƒãƒ—ã®æ¤œç´¢çµæœã¯ã€æ¤œç´¢å ´æ‰€ã‚„å±¥æ­´ã«ã‚ˆã£ã¦å¤‰å‹•ã—ã¾ã™ãŒã€ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ä»¥ä¸‹ã®æ–¹æ³•ã§å®¢è¦³çš„ãªé †ä½ã‚’è¨ˆæ¸¬ã—ã¦ã„ã¾ã™ã€‚

1. ã‚¯ãƒªãƒ¼ãƒ³ãªç’°å¢ƒ: å±¥æ­´ã®ãªã„ãƒ–ãƒ©ã‚¦ã‚¶ã§è¨ˆæ¸¬ã—ã¾ã™ã€‚
2. æ¤œç´¢å ´æ‰€ã®å›ºå®š: ã‚ãªãŸã®PCã®å ´æ‰€ã§ã¯ãªãã€æŒ‡å®šã•ã‚ŒãŸæ¤œç´¢åœ°ç‚¹ï¼ˆä¾‹ï¼šã€Œç¦å±±é§…ã€ï¼‰ã®åº§æ¨™ã‚’ä»®æƒ³çš„ã«è¨­å®šã—ã¦æ¤œç´¢ã—ã¾ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€èª°ãŒã©ã“ã§è¨ˆæ¸¬ã—ã¦ã‚‚ã€å¸¸ã«ã€ŒæŒ‡å®šã—ãŸåœ°ç‚¹ã®å‘¨è¾ºã§ã®æ¤œç´¢çµæœã€ã¨ã„ã†åŒã˜æ¡ä»¶ä¸‹ã§ã®é †ä½ã‚’ç¢ºèªã§ãã¾ã™ã€‚`;
                }

                alert(helpText);
            });

            // æ‰‹å‹•è¨ˆæ¸¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¸ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³
            scrollToManualCheckButton.addEventListener('click', () => {
                const manualCheckSection = document.getElementById('manualCheckSection');
                manualCheckSection.scrollIntoView({ behavior: 'smooth' });
            });
            let rankChart = null; // ã‚°ãƒ©ãƒ•ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒã™ã‚‹å¤‰æ•°

            // --- CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ ---
            function exportToCsv(groupKey, groupData, activeSearchType) {
                // 1. å…¨æ—¥ä»˜ã®ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã€ã‚½ãƒ¼ãƒˆã™ã‚‹
                const allDates = new Set();
                groupData.forEach(task => task.log.forEach(entry => allDates.add(entry.date)));
                const sortedDates = Array.from(allDates).sort((a, b) => new Date(a) - new Date(b));

                // 2. ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ä½œæˆ
                let headerLabel = 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰';
                if (activeSearchType === 'special') headerLabel = 'ã‚µãƒ­ãƒ³å';
                let csvContent = `"${headerLabel}",` + sortedDates.join(',') + '\n';

                // 3. ãƒ‡ãƒ¼ã‚¿è¡Œã‚’ä½œæˆ
                groupData.forEach(taskData => {
                    let rowLabel = '';
                    if (activeSearchType === 'normal') {
                        rowLabel = taskData.task.serviceKeyword;
                    } else if (activeSearchType === 'special') {
                        rowLabel = taskData.task.salonName;
                    } else if (activeSearchType === 'google') {
                        rowLabel = taskData.task.keyword;
                    }

                    const dataMap = new Map(taskData.log.map(entry => [entry.date, entry.rank]));
                    const rowData = sortedDates.map(date => dataMap.get(date) || '').join(',');
                    csvContent += `"${rowLabel}",${rowData}\n`;
                });

                // 4. BOMã‚’è¿½åŠ ã—ã¦æ–‡å­—åŒ–ã‘ã‚’é˜²ã
                const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
                const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });

                // 5. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã¦ã‚¯ãƒªãƒƒã‚¯
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);

                // ãƒ•ã‚¡ã‚¤ãƒ«åã®ç”Ÿæˆ
                const safeGroupKey = groupKey.replace(/[\\/:*?"<>|]/g, '_');
                let typeName = '';
                if (activeSearchType === 'normal') typeName = 'HPBé€šå¸¸';
                else if (activeSearchType === 'special') typeName = 'HPBç‰¹é›†';
                else if (activeSearchType === 'google') typeName = 'MEO';
                const fileName = `${safeGroupKey}_${typeName}å±¥æ­´.csv`;

                link.setAttribute("download", fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
            function escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            function openResultInNewTab(resultData) {
                const newTab = window.open('', '_blank');
                if (!newTab) {
                    alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æ–°ã—ã„ã‚¿ãƒ–ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚');
                    return;
                }

                const screenshotHtml = resultData.screenshot_path
                    ? `
                        <h2>ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ</h2>
                        <a href="${resultData.screenshot_path}" target="_blank"><img src="${resultData.screenshot_path}" style="max-width: 100%; border: 1px solid #ddd;" alt="Screenshot"></a>
                    `
                    : '<h2>ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</h2>';

                const debugHtmlContent = resultData.html ? escapeHtml(resultData.html) : 'HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';

                const debugInfoHtml = `
                    <h2>ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h2>
                    <p><strong>æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹URL:</strong> <a href="${resultData.url || '#'}" target="_blank">${resultData.url || 'N/A'}</a></p>
                    <p><strong>å–å¾—ã—ãŸãƒšãƒ¼ã‚¸ã®HTMLã‚½ãƒ¼ã‚¹:</strong></p>
                    <textarea style="width: 98%; height: 400px; font-family: monospace; border: 1px solid #ccc; padding: 5px;" readonly>${debugHtmlContent}</textarea>
                `;

                const newTabContent = `
                    <!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><title>è¨ˆæ¸¬è©³ç´° - ${resultData.keyword || ''}</title>
                    <style>body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 20px; line-height: 1.6; } h1, h2 { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }</style>
                    </head><body><h1>è¨ˆæ¸¬è©³ç´°</h1>${screenshotHtml}<hr style="margin: 20px 0;">${debugInfoHtml}</body></html>
                `;

                newTab.document.write(newTabContent);
                newTab.document.close();
            }

            // é †ä½ã‚’ã‚°ãƒ©ãƒ•ã®Yè»¸åº§æ¨™ã«å¤‰æ›ã™ã‚‹ï¼ˆç·šå½¢è£œé–“ï¼‰
            function convertRankToY(rank) {
                if (typeof rank !== 'number') {
                    if (rank === 'åœå¤–') {
                        return 1.5; // 'åœå¤–' ã®Yåº§æ¨™
                    }
                    // ã€Œæ ç„¡ã€ã€Œã‚¨ãƒ©ãƒ¼ã€ã€Œã‚¹ã‚­ãƒƒãƒ—ã€ãªã©ã¯ã‚°ãƒ©ãƒ•ã«è¡¨ç¤ºã—ãªã„
                    return NaN;
                }

                const points = [
                    { rank: 1, y: 6 },
                    { rank: 5, y: 5 },
                    { rank: 20, y: 4 },
                    { rank: 50, y: 3 },
                    { rank: 100, y: 2 }
                ];

                // ãƒ©ãƒ³ã‚¯ãŒã©ã®åŒºé–“ã«å±ã™ã‚‹ã‹ã‚’è¦‹ã¤ã‘ã‚‹
                for (let i = 0; i < points.length - 1; i++) {
                    const p1 = points[i];
                    const p2 = points[i + 1];
                    if (rank >= p1.rank && rank <= p2.rank) {
                        const rankRange = p2.rank - p1.rank;
                        const yRange = p1.y - p2.y;
                        const rankOffset = rank - p1.rank;
                        return p1.y - ((rankOffset / (rankRange || 1)) * yRange);
                    }
                }
                return (rank < 1) ? 6 : 1.5; // 1ä½ã‚ˆã‚Šè‰¯ã„ã‹ã€100ä½ã‚ˆã‚Šæ‚ªã„å ´åˆ
            }

            // --- UIã®çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹é–¢æ•° ---
            let isMeasuring = false;
            function setMeasuringState(measuring) {
                isMeasuring = measuring;
                // è¨ˆæ¸¬å®Ÿè¡Œãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
                checkRankButton.disabled = measuring;
                manualTriggerButton.disabled = measuring;

                // è¨ˆæ¸¬ä¸­ã¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã¨ã‚¿ã‚¹ã‚¯è¿½åŠ /ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                searchTypeToggle.querySelectorAll('button').forEach(btn => btn.disabled = measuring);
                addAutoTaskButton.disabled = measuring;
                copyButton.disabled = measuring; // MEOã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
                hpbNormalCopyButton.disabled = measuring; // HPBé€šå¸¸ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
                hpbSpecialCopyButton.disabled = measuring; // HPBç‰¹é›†ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
            }

            checkRankButton.addEventListener('click', async () => {
                const salonName = salonNameInput.value.trim();
                const activeSearchType = searchTypeToggle.querySelector('.toggle-button.active').dataset.type;

                let serviceKeywords = [];
                let areaCodes = {};
                let areaName = '';

                if (activeSearchType === 'normal') {
                    const largeArea = largeAreaSelect.value;
                    const middleArea = middleAreaSelect.value;
                    const smallArea = smallAreaSelect.value;
                    const keywordsRaw = keywordInput.value.trim();

                    if (!salonName) {
                        alert('è‡ªåº—ã®ã‚µãƒ­ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    if (!largeArea || !keywordsRaw) {
                        alert('é€šå¸¸æ¤œç´¢ã§ã¯ã€ã‚¨ãƒªã‚¢ãƒ–ãƒ­ãƒƒã‚¯ã¨æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    serviceKeywords = keywordsRaw.split(/[\s,ã€]+/).filter(k => k);
                    areaName = smallArea || middleArea || largeArea;
                    if (largeArea) areaCodes.serviceAreaCd = areas[largeArea].code;
                    if (middleArea) areaCodes.middleAreaCd = areas[largeArea].middleAreas[middleArea].code;
                    if (smallArea) areaCodes.smallAreaCd = areas[largeArea].middleAreas[middleArea].smallAreas[smallArea].code; // ã“ã®è¡Œã¯å¤‰æ›´ãªã—
                } else if (activeSearchType === 'special') { // special
                    const featureUrl = featurePageUrlInput.value.trim();
                    if (!featureUrl) {
                        alert('ç‰¹é›†ãƒšãƒ¼ã‚¸æ¤œç´¢ã§ã¯ã€URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    if (!salonName) {
                        alert('ç‰¹é›†ãƒšãƒ¼ã‚¸æ¤œç´¢ã§ã¯ã€URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    serviceKeywords.push(featureUrl); // ç‰¹é›†ãƒšãƒ¼ã‚¸ã¯URLã‚’ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ã—ã¦1ã‚¿ã‚¹ã‚¯ã¨ã—ã¦æ‰±ã†
                } else if (activeSearchType === 'google') {
                    const googleKeyword = document.getElementById('googleKeywordInput').value.trim();
                    const searchLocation = document.getElementById('searchLocationInput').value.trim();
                    if (!salonName) {
                        alert('MEOæ¤œç´¢ã§ã¯ã€è‡ªåº—ã®ã‚µãƒ­ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    if (!googleKeyword || !searchLocation) {
                        alert('MEOæ¤œç´¢ã§ã¯ã€æ¤œç´¢åœ°ç‚¹ã¨æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    serviceKeywords.push(googleKeyword); // MEOã§ã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯1ã¤ãšã¤
                } else if (activeSearchType === 'seo') {
                }

                setMeasuringState(true); // è¨ˆæ¸¬çŠ¶æ…‹ã‚’é–‹å§‹ã«è¨­å®š
                checkRankButton.textContent = 'è¨ˆæ¸¬ä¸­...';
                resultArea.innerHTML = ''; // ä»¥å‰ã®çµæœã‚’ã‚¯ãƒªã‚¢

                // --- æ‰€è¦æ™‚é–“è¨ˆæ¸¬é–‹å§‹ ---
                const startTime = performance.now();
                let timerInterval = null;

                // å…¨ä½“ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ
                const overallStatusContainer = document.createElement('div');
                overallStatusContainer.id = 'overallStatus';
                overallStatusContainer.style.padding = '10px';
                overallStatusContainer.style.marginBottom = '15px';
                overallStatusContainer.style.borderBottom = '1px solid #ddd';
                overallStatusContainer.style.fontWeight = '500';
                resultArea.appendChild(overallStatusContainer);

                // --- çµŒéæ™‚é–“è¡¨ç¤ºã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹ ---
                timerInterval = setInterval(() => {
                    const elapsedTotalSeconds = Math.floor((performance.now() - startTime) / 1000);
                    const minutes = Math.floor(elapsedTotalSeconds / 60);
                    const seconds = elapsedTotalSeconds % 60;
                    const durationString = minutes > 0 ? `${minutes}åˆ†${seconds}ç§’` : `${seconds}ç§’`;
                    const currentText = overallStatusContainer.textContent;
                    // æœ€å¾Œã®æ‹¬å¼§éƒ¨åˆ†ã‚’æ™‚é–“è¡¨ç¤ºã§ç½®ãæ›ãˆã‚‹
                    const baseText = currentText.replace(/\s*\([^)]*\)$/, '');
                    if (baseText) { // è¨ˆæ¸¬å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã¯è¿½è¨˜ã—ãªã„
                        overallStatusContainer.textContent = `${baseText} (çµŒéæ™‚é–“: ${durationString})`;
                    }
                }, 1000);

                for (const [index, serviceKeyword] of serviceKeywords.entries()) {
                    // å„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®çµæœã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ
                    // å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨ã¯åˆ¥ã«ã€å„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ä½œæˆ
                    const keywordResultContainer = document.createElement('div');
                    keywordResultContainer.style.borderBottom = '1px solid #e5e5e7';
                    keywordResultContainer.style.paddingBottom = '15px';
                    keywordResultContainer.style.marginBottom = '15px';
                    resultArea.appendChild(keywordResultContainer);

                    let fullKeyword = '';
                    let eventSourceUrl = '';
                    if (activeSearchType === 'normal') {
                        const displayArea = areaName || "ã‚¨ãƒªã‚¢æœªæŒ‡å®š";
                        fullKeyword = (displayArea !== "å…¨å›½" ? displayArea + ' ' : '') + serviceKeyword;
                        eventSourceUrl = `/check-ranking?` + new URLSearchParams({
                            serviceKeyword, salonName, areaCodes: JSON.stringify(areaCodes)
                        });
                    } else if (activeSearchType === 'google') {
                        const searchLocation = document.getElementById('searchLocationInput').value.trim();
                        fullKeyword = `[${searchLocation}] ${serviceKeyword}`;
                        eventSourceUrl = `/check-meo-ranking?` + new URLSearchParams({
                            keyword: serviceKeyword,
                            location: searchLocation,
                            // salonName: salonName // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã®ç…§åˆã¯ä¸è¦ã«ãªã£ãŸãŸã‚å‰Šé™¤
                        });
                    } else { // special
                        fullKeyword = serviceKeyword; // ã“ã®æ™‚ç‚¹ã§ã¯URLãã®ã‚‚ã®
                        eventSourceUrl = `/check-feature-page-ranking?` + new URLSearchParams({
                            featurePageUrl: serviceKeyword, salonName
                        });
                    }
                    
                    // å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
                    overallStatusContainer.textContent = `${index + 1} / ${serviceKeywords.length} ä»¶ç›®: ã€Œ${fullKeyword}ã€ã‚’è¨ˆæ¸¬ä¸­... `; // æœ«å°¾ã«ã‚¹ãƒšãƒ¼ã‚¹
                    // å€‹åˆ¥ã®çµæœã‚¨ãƒªã‚¢ã«ã‚‚åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    keywordResultContainer.innerHTML = `<h4 style="margin-top:0; margin-bottom: 10px;">ã€Œ${fullKeyword}ã€</h4><p>è¨ˆæ¸¬ã—ã¦ã„ã¾ã™...</p>`;

                    await new Promise((resolve, reject) => {
                        const eventSource = new EventSource(eventSourceUrl, { withCredentials: true });

                        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå±ŠããŸã³ã«å‘¼ã³å‡ºã•ã‚Œã‚‹
                        eventSource.onmessage = (event) => {
                            const data = JSON.parse(event.data);

                            if (data.error) {
                                keywordResultContainer.innerHTML = `<h4 style="margin-top:0; margin-bottom: 10px;">ã€Œ${fullKeyword}ã€</h4><p style="color: red;">ã‚¨ãƒ©ãƒ¼: ${data.error}</p>`;
                                eventSource.close();
                                reject(new Error(data.error));
                                return;
                            }

                            if (data.status) {
                                // è©³ç´°ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å€‹åˆ¥ã®çµæœã‚¨ãƒªã‚¢ã«è¡¨ç¤º
                                keywordResultContainer.innerHTML = `<h4 style="margin-top:0; margin-bottom: 10px;">ã€Œ${fullKeyword}ã€</h4><p>${data.status}</p>`;
                            }

                            if (data.final_result) {
                                const result = data.final_result;
                                // ç‰¹é›†ãƒšãƒ¼ã‚¸ã®å ´åˆã€ã‚¿ã‚¤ãƒˆãƒ«ã§è¡¨ç¤ºã‚’æ›´æ–°
                                const resultTitle = (activeSearchType === 'special') ? (result.page_title || fullKeyword) : fullKeyword;
                                result.keyword = resultTitle;

                                let totalCountHtml = (result.total_count !== undefined) ? `<p style="font-size: 14px; color: #6c6c70; margin-bottom: 10px;">æ¤œç´¢çµæœç·æ•°: <strong style="color: #1c1c1e;">${result.total_count}</strong> ä»¶</p>` : '';
                                let resultMessageHtml;

                                // --- MEOã¨ãã‚Œä»¥å¤–ã§çµæœè¡¨ç¤ºã‚’åˆ†å² ---
                                if (activeSearchType === 'google') {
                                    if (result.results && result.results.length > 0) {
                                        let foundMySalon = false;
                                        const resultsListHtml = result.results.map((item, index) => {
                                            const isMySalon = salonName && item.foundSalonName.toLowerCase().includes(salonName.toLowerCase());
                                            if (isMySalon) foundMySalon = true;
                                            const itemStyle = isMySalon ? 'background-color: #eef7ff; border-left: 3px solid #007aff;' : '';
                                            const rankColor = isMySalon ? '#007aff' : '#1c1c1e';
                                            return `
                                                <div style="padding: 10px; ${index < result.results.length - 1 ? 'border-bottom: 1px solid #e5e5e7;' : ''} ${itemStyle}">
                                                    <p style="margin: 0; font-size: 16px; font-weight: bold;"><span style="color: ${rankColor}; font-size: 1.2em; display: inline-block; width: 3em;">${item.rank}ä½</span> ${escapeHtml(item.foundSalonName)}</p>
                                                </div>
                                            `;
                                        }).join('');
                                        
                                        const summaryMessage = foundMySalon 
                                            ? `<p style="font-weight: bold; color: #007aff; margin-bottom: 15px;">è‡ªåº—ã‚’ãƒªã‚¹ãƒˆå†…ã«ç™ºè¦‹ã—ã¾ã—ãŸã€‚</p>`
                                            : `<p style="font-weight: bold; color: #ff3b30; margin-bottom: 15px;">è‡ªåº—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ä»¥ä¸‹ã®ãƒªã‚¹ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>`;

                                        resultMessageHtml = `${summaryMessage}<div style="text-align: left; max-height: 400px; overflow-y: auto;">${resultsListHtml}</div>`;

                                        // --- MEOã®å±¥æ­´ä¿å­˜å‡¦ç† ---
                                        const mySalonRankItem = result.results.find(item => salonName && item.foundSalonName.toLowerCase().includes(salonName.toLowerCase()));
                                        const finalRank = mySalonRankItem ? mySalonRankItem.rank : 'åœå¤–';
                                        const searchLocation = document.getElementById('searchLocationInput').value.trim();
                                        const googleKeyword = document.getElementById('googleKeywordInput').value.trim();
                                        if (result.rank === "ã‚¨ãƒªã‚¢ä¸ä¸€è‡´") {
                                            resultMessageHtml = `<p style="color: #ff9500;">æ¤œç´¢åœ°ç‚¹ã¨çµæœãŒä¸€è‡´ã—ã¾ã›ã‚“ã§ã—ãŸ (ã‚¨ãƒªã‚¢ä¸ä¸€è‡´)</p>`;
                                        }
                                        // IDã®å½¢å¼ã‚’çµ±ä¸€ã™ã‚‹
                                        // å¤ã„å½¢å¼ã®IDãŒ "[google]-" ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãªã—ã§ä½œæˆã•ã‚Œã¦ã„ãŸãŸã‚ã€
                                        // æ–°ã—ãä½œæˆã™ã‚‹éš›ã¯å¿…ãšãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’ä»˜ã‘ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
                                        const taskId = `[google]-${salonName}-${searchLocation}-${googleKeyword}`; 
                                        const taskPayload = { id: taskId, type: 'google', salonName, searchLocation, keyword: googleKeyword };
                                        const historyPayload = {
                                            task: taskPayload,
                                            result: { rank: finalRank, screenshot_path: result.screenshot_path }
                                        };
                                        saveManualHistory(historyPayload);

                                    } else {
                                        resultMessageHtml = `<p>æ¤œç´¢çµæœã«åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>`;
                                    }
                                } else { // é€šå¸¸æ¤œç´¢ã¨ç‰¹é›†ãƒšãƒ¼ã‚¸æ¤œç´¢ã®å ´åˆ
                                    if (result.results && result.results.length > 0) {
                                        const resultsListHtml = result.results.map((item, index) => {
                                            const isMySalon = salonName && item.foundSalonName.includes(salonName);
                                            const itemStyle = isMySalon ? 'background-color: #eef7ff; border-left: 3px solid #007aff;' : '';
                                            const rankColor = isMySalon ? '#007aff' : '#1c1c1e';

                                            return `
                                                <div style="padding: 10px; ${index < result.results.length - 1 ? 'border-bottom: 1px solid #e5e5e7;' : ''} ${itemStyle}">
                                                    <p style="margin: 0; font-size: 16px; font-weight: bold;"><span style="color: ${rankColor}; font-size: 1.2em; display: inline-block; width: 3em;">${item.rank}ä½</span> ${escapeHtml(item.foundSalonName)}</p>
                                                </div>
                                            `;
                                        }).join('');
                                        resultMessageHtml = `<div style="text-align: left;">${resultsListHtml}</div>`;
                                        
                                        // --- å±¥æ­´ä¿å­˜ã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIå‘¼ã³å‡ºã—ã«å¤‰æ›´ ---
                                        const finalRank = result.results[0].rank;
                                        let taskId, taskPayload;
                                        if (activeSearchType === 'normal') {
                                            taskId = `${salonName}-${areaName}-${serviceKeyword}`;
                                            taskPayload = { id: taskId, type: 'normal', salonName, areaName, areaCodes, serviceKeyword };
                                        } else if (activeSearchType === 'special') {
                                            taskId = `${salonName}-${serviceKeyword}`; // URLã‚’IDã®ä¸€éƒ¨ã«
                                            taskPayload = { id: taskId, type: 'special', salonName, featurePageUrl: serviceKeyword, featurePageName: result.page_title };
                                        } else {
                                            taskPayload = null;
                                        }
                                        if (taskPayload) {
                                            const historyPayload = {
                                                task: taskPayload,
                                                result: { rank: finalRank, screenshot_path: result.screenshot_path }
                                            };
                                            saveManualHistory(historyPayload);
                                        }
                                    } else { // åœå¤–ã®å ´åˆ
                                        resultMessageHtml = `<p>5ãƒšãƒ¼ã‚¸ï¼ˆ100ä½ï¼‰ä»¥å†…ã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ (åœå¤–)</p>`;
                                        // --- åœå¤–ã®å ´åˆã®å±¥æ­´ä¿å­˜å‡¦ç†ã‚’è¿½åŠ  ---
                                        let taskId, taskPayload;
                                        if (activeSearchType === 'normal') {
                                            taskId = `${salonName}-${areaName}-${serviceKeyword}`;
                                            taskPayload = { id: taskId, type: 'normal', salonName, areaName, areaCodes, serviceKeyword };
                                        } else if (activeSearchType === 'special') {
                                            taskId = `${salonName}-${serviceKeyword}`;
                                            taskPayload = { id: taskId, type: 'special', salonName, featurePageUrl: serviceKeyword, featurePageName: result.page_title };
                                        } else {
                                            taskPayload = null;
                                        }
                                        if (taskPayload) {
                                            const historyPayload = {
                                                task: taskPayload,
                                                result: { rank: 'åœå¤–', screenshot_path: result.screenshot_path }
                                            };
                                            saveManualHistory(historyPayload);
                                        }
                                    }
                                }

                                function saveManualHistory(payload) {
                                    fetch('/api/save-auto-history-entry', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(payload) // å¼•æ•° payload ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£
                                    }).catch(err => console.error('å±¥æ­´ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', err));
                                }

                                keywordResultContainer.innerHTML = `<h4 style="margin-top:0; margin-bottom: 10px;">ã€Œ${fullKeyword}ã€</h4>${totalCountHtml}${resultMessageHtml}`;
                                keywordResultContainer.style.cursor = 'pointer';
                                keywordResultContainer.title = 'ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°ï¼ˆã‚¹ã‚¯ã‚·ãƒ§ã¨ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼‰ã‚’è¡¨ç¤º';
                                keywordResultContainer.onclick = () => openResultInNewTab(result);
                                
                                eventSource.close();
                                resolve();
                            }
                        };

                        eventSource.onerror = (err) => {
                            keywordResultContainer.innerHTML = `<h4 style="margin-top:0; margin-bottom: 10px;">ã€Œ${fullKeyword}ã€</h4><p style="color: red;">ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>`;
                            eventSource.close();
                            reject(err);
                        };
                    }).catch(error => {
                        console.error(`ã€Œ${fullKeyword}ã€ã®è¨ˆæ¸¬ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:`, error);
                    });
                }

                // --- ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢ ---
                clearInterval(timerInterval);

                // --- æ‰€è¦æ™‚é–“è¨ˆæ¸¬çµ‚äº† ---
                const endTime = performance.now();
                const elapsedTotalSeconds = Math.floor((endTime - startTime) / 1000);
                const minutes = Math.floor(elapsedTotalSeconds / 60);
                const seconds = elapsedTotalSeconds % 60;
                const durationString = minutes > 0 ? `${minutes}åˆ†${seconds}ç§’` : `${seconds}ç§’`;

                // å…¨ã¦ã®è¨ˆæ¸¬ãŒå®Œäº†ã—ãŸã“ã¨ã‚’é€šçŸ¥
                overallStatusContainer.textContent = `ã™ã¹ã¦ã®è¨ˆæ¸¬ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ï¼ˆ${serviceKeywords.length}ä»¶ / æ‰€è¦æ™‚é–“: ${durationString}ï¼‰`;
                // å…¨ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ãŸã‚‰UIã®çŠ¶æ…‹ã‚’å…ƒã«æˆ»ã™
                setMeasuringState(false);
                checkRankButton.textContent = 'é †ä½ã‚’è¨ˆæ¸¬';
                fetchAndDisplayAutoHistory(); // è‡ªå‹•è¨ˆæ¸¬å±¥æ­´ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
            });

            // --- è‡ªå‹•è¨ˆæ¸¬ å®Ÿè¡Œæ™‚é–“è¨­å®š ---
            // æ™‚é–“é¸æŠã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ç”Ÿæˆ (0-23æ™‚)
            for (let i = 0; i < 24; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i}`.padStart(2, '0');
                scheduleHourSelect.appendChild(option);
            }

            // ç¾åœ¨ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®šã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹é–¢æ•°
            const fetchSchedule = async () => {
                try {
                    const response = await fetch('/api/schedule');
                    if (response.ok) {
                        const data = await response.json();
                        scheduleHourSelect.value = data.hour;
                        scheduleStatus.textContent = `ç¾åœ¨ã®è¨­å®š: æ¯æ—¥ ${String(data.hour).padStart(2, '0')}:${String(data.minute).padStart(2, '0')} ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚`;
                    } else {
                        scheduleStatus.textContent = 'ç¾åœ¨ã®è¨­å®šæ™‚é–“ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
                    }
                } catch (error) {
                    console.error('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                    scheduleStatus.textContent = 'ç¾åœ¨ã®è¨­å®šæ™‚é–“ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
                }
            };

            // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            saveScheduleButton.addEventListener('click', async () => {
                const newHour = parseInt(scheduleHourSelect.value, 10);
                if (isNaN(newHour)) {
                    alert('æœ‰åŠ¹ãªæ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                saveScheduleButton.disabled = true;
                saveScheduleButton.textContent = 'ä¿å­˜ä¸­...';

                try {
                    const response = await fetch('/api/schedule', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ hour: newHour, minute: 0 }), // åˆ†ã¯0ã§å›ºå®š
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    alert(result.message);
                    fetchSchedule(); // è¡¨ç¤ºã‚’æ›´æ–°
                } catch (error) {
                    alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                } finally {
                    saveScheduleButton.disabled = false;
                    saveScheduleButton.textContent = 'è¨­å®šã‚’ä¿å­˜';
                }
            });

            // --- è‡ªå‹•è¨ˆæ¸¬ã‚¿ã‚¹ã‚¯ä¸€è¦§ã®é–‹é–‰ ---
            autoTaskListToggle.addEventListener('click', () => {
                const isVisible = autoTaskListContent.style.display === 'block';
                if (isVisible) {
                    localStorage.setItem('taskListVisible', 'false');
                    autoTaskListContent.style.display = 'none';
                    taskListToggleIcon.style.transform = 'rotate(0deg)';
                } else {
                    localStorage.setItem('taskListVisible', 'true');
                    autoTaskListContent.style.display = 'block';
                    taskListToggleIcon.style.transform = 'rotate(180deg)';
                }
            });

            // --- MEOã‚¿ã‚¹ã‚¯ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ ---
            const copySourceSelect = document.getElementById('copySourceLocation');
            const copyDestInput = document.getElementById('copyDestLocation');
            const copyButton = document.getElementById('executeCopyButton');

            function updateCopySourceLocations() {
                const meoTasks = autoTasks.filter(task => task.type === 'google');
                const locations = [...new Set(meoTasks.map(task => task.searchLocation))];
                
                copySourceSelect.innerHTML = ''; // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ã‚¯ãƒªã‚¢
                if (locations.length === 0) {
                    const option = document.createElement('option');
                    option.textContent = 'ã‚³ãƒ”ãƒ¼å…ƒã®åœ°ç‚¹ãŒã‚ã‚Šã¾ã›ã‚“';
                    option.disabled = true;
                    copySourceSelect.appendChild(option);
                    copyButton.disabled = true;
                    return;
                }

                locations.sort((a,b) => a.localeCompare(b, 'ja'));
                locations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location;
                    option.textContent = location;
                    copySourceSelect.appendChild(option);
                });
                copyButton.disabled = false;
            }

            copyButton.addEventListener('click', () => {
                const sourceLocation = copySourceSelect.value;
                const destLocation = copyDestInput.value.trim();

                if (!sourceLocation || !destLocation) {
                    alert('ã‚³ãƒ”ãƒ¼å…ƒã¨ã‚³ãƒ”ãƒ¼å…ˆã®ä¸¡æ–¹ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                if (sourceLocation === destLocation) {
                    alert('ã‚³ãƒ”ãƒ¼å…ƒã¨ã‚³ãƒ”ãƒ¼å…ˆãŒåŒã˜ã§ã™ã€‚');
                    return;
                }

                const tasksToCopy = autoTasks.filter(task => task.type === 'google' && task.searchLocation === sourceLocation);
                
                if (!confirm(`ã€Œ${sourceLocation}ã€ã®${tasksToCopy.length}å€‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã€Œ${destLocation}ã€ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    return;
                }

                tasksToCopy.forEach(task => {
                    const salonName = task.salonName;
                    const originalKeyword = task.keyword;
                    let newKeyword = originalKeyword;

                    // --- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å†…ã®åœ°åã‚’ç½®æ›ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ ---
                    const sourceLocationBase = sourceLocation.replace(/é§…|å¸‚$/, '').trim();
                    const destLocationBase = destLocation.replace(/é§…|å¸‚$/, '').trim();

                    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã‚³ãƒ”ãƒ¼å…ƒã®åœ°åã§å§‹ã¾ã£ã¦ã„ã‚‹å ´åˆã€ã‚³ãƒ”ãƒ¼å…ˆã®åœ°åã«ç½®ãæ›ãˆã‚‹
                    if (sourceLocationBase && originalKeyword.startsWith(sourceLocationBase)) {
                        newKeyword = destLocationBase + originalKeyword.substring(sourceLocationBase.length);
                    }

                    const newTaskId = `[google]-${salonName}-${destLocation}-${newKeyword}`;
                    if (!autoTasks.some(t => t.id === newTaskId)) {
                        autoTasks.push({ id: newTaskId, type: 'google', salonName: salonName, searchLocation: destLocation, keyword: newKeyword });
                    }
                });

                saveAutoTasks();
                renderAutoTasks();
                alert(`ã‚¿ã‚¹ã‚¯ã®ã‚³ãƒ”ãƒ¼ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã€Œ${destLocation}ã€ã®ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
                copyDestInput.value = ''; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            });
            
            // --- HPBé€šå¸¸ã‚¿ã‚¹ã‚¯ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ ---
            const copySourceAreaSelect = document.getElementById('copySourceArea');
            const copyDestAreaSelect = document.getElementById('copyDestArea');
            const hpbNormalCopyButton = document.getElementById('executeHpbNormalCopyButton');

            function updateHpbNormalCopySources() {
                const normalTasks = autoTasks.filter(task => (task.type || 'normal') === 'normal');
                const sourceAreas = [...new Set(normalTasks.map(task => task.areaName))];
                
                copySourceAreaSelect.innerHTML = '';
                if (sourceAreas.length === 0) {
                    const option = document.createElement('option');
                    option.textContent = 'ã‚³ãƒ”ãƒ¼å…ƒã®ã‚¨ãƒªã‚¢ãŒã‚ã‚Šã¾ã›ã‚“';
                    option.disabled = true;
                    copySourceAreaSelect.appendChild(option);
                    hpbNormalCopyButton.disabled = true;
                } else {
                    sourceAreas.sort((a,b) => a.localeCompare(b, 'ja'));
                    sourceAreas.forEach(area => {
                        const option = document.createElement('option');
                        option.value = area;
                        option.textContent = area;
                        copySourceAreaSelect.appendChild(option);
                    });
                    hpbNormalCopyButton.disabled = false;
                }

                // ã‚³ãƒ”ãƒ¼å…ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ç”Ÿæˆ
                copyDestAreaSelect.innerHTML = '';
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'ã‚³ãƒ”ãƒ¼å…ˆã®ã‚¨ãƒªã‚¢ã‚’é¸æŠ';
                defaultOption.disabled = true;
                defaultOption.selected = true;
                copyDestAreaSelect.appendChild(defaultOption);

                Object.keys(areas).sort((a,b) => a.localeCompare(b, 'ja')).forEach(largeAreaName => {
                    const largeArea = areas[largeAreaName];
                    
                    // å¤§ã‚¨ãƒªã‚¢è‡ªä½“ã‚’ã‚³ãƒ”ãƒ¼å…ˆã¨ã—ã¦è¿½åŠ 
                    let largeAreaOption = document.createElement('option');
                    largeAreaOption.value = JSON.stringify({
                        areaName: largeAreaName,
                        areaCodes: { serviceAreaCd: largeArea.code }
                    });
                    largeAreaOption.textContent = `${largeAreaName} (å…¨åŸŸ)`;
                    copyDestAreaSelect.appendChild(largeAreaOption);

                    Object.keys(largeArea.middleAreas).sort((a,b) => a.localeCompare(b, 'ja')).forEach(middleAreaName => {
                        const option = document.createElement('option');
                        option.value = JSON.stringify({
                            areaName: middleAreaName,
                            areaCodes: { serviceAreaCd: largeArea.code, middleAreaCd: largeArea.middleAreas[middleAreaName].code }
                        });
                        option.textContent = `${largeAreaName} > ${middleAreaName}`;
                        copyDestAreaSelect.appendChild(option);

                        // å°ã‚¨ãƒªã‚¢ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ãã‚Œã‚‚è¿½åŠ 
                        const smallAreaDefs = largeArea.middleAreas[middleAreaName].smallAreas;
                        if (smallAreaDefs && Object.keys(smallAreaDefs).length > 0) {
                            Object.keys(smallAreaDefs).sort((a,b) => a.localeCompare(b, 'ja')).forEach(smallAreaName => {
                                const smallAreaOption = document.createElement('option');
                                smallAreaOption.value = JSON.stringify({
                                    areaName: smallAreaName,
                                    areaCodes: { serviceAreaCd: largeArea.code, middleAreaCd: largeArea.middleAreas[middleAreaName].code, smallAreaCd: smallAreaDefs[smallAreaName].code }
                                });
                                smallAreaOption.textContent = `${largeAreaName} > ${middleAreaName} > ${smallAreaName}`;
                                copyDestAreaSelect.appendChild(smallAreaOption);
                            });
                        }
                    });
                });
            }

            hpbNormalCopyButton.addEventListener('click', () => {
                const sourceAreaName = copySourceAreaSelect.value;
                if (!copyDestAreaSelect.value) {
                    alert('ã‚³ãƒ”ãƒ¼å…ˆã®ã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                const { areaName: destAreaName, areaCodes: destAreaCodes } = JSON.parse(copyDestAreaSelect.value);

                if (!sourceAreaName || !destAreaName) {
                    alert('ã‚³ãƒ”ãƒ¼å…ƒã¨ã‚³ãƒ”ãƒ¼å…ˆã®ä¸¡æ–¹ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                if (sourceAreaName === destAreaName) {
                    alert('ã‚³ãƒ”ãƒ¼å…ƒã¨ã‚³ãƒ”ãƒ¼å…ˆãŒåŒã˜ã§ã™ã€‚');
                    return;
                }

                const tasksToCopy = autoTasks.filter(task => (task.type || 'normal') === 'normal' && task.areaName === sourceAreaName);
                if (!confirm(`ã€Œ${sourceAreaName}ã€ã®${tasksToCopy.length}å€‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã€Œ${destAreaName}ã€ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    return;
                }

                tasksToCopy.forEach(task => {
                    const newTaskId = `${task.salonName}-${destAreaName}-${task.serviceKeyword}`;
                    if (!autoTasks.some(t => t.id === newTaskId)) {
                        autoTasks.push({
                            id: newTaskId,
                            type: 'normal',
                            salonName: task.salonName,
                            areaName: destAreaName,
                            areaCodes: destAreaCodes,
                            serviceKeyword: task.serviceKeyword
                        });
                    }
                });

                saveAutoTasks();
                renderAutoTasks();
                alert(`ã‚¿ã‚¹ã‚¯ã®ã‚³ãƒ”ãƒ¼ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã€Œ${destAreaName}ã€ã®ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
            });

            // --- HPBç‰¹é›†ã‚¿ã‚¹ã‚¯ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ ---
            const copySourceSpecialPageSelect = document.getElementById('copySourceSpecialPage');
            const copyDestSpecialPageUrlInput = document.getElementById('copyDestSpecialPageUrl');
            const hpbSpecialCopyButton = document.getElementById('executeHpbSpecialCopyButton');

            function updateHpbSpecialCopySources() {
                const specialTasks = autoTasks.filter(task => task.type === 'special');
                const sourcePages = [...new Map(specialTasks.map(task => [task.featurePageUrl, task.featurePageName || task.featurePageUrl])).entries()];

                copySourceSpecialPageSelect.innerHTML = '';
                if (sourcePages.length === 0) {
                    const option = document.createElement('option');
                    option.textContent = 'ã‚³ãƒ”ãƒ¼å…ƒã®ç‰¹é›†ãƒšãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“';
                    option.disabled = true;
                    copySourceSpecialPageSelect.appendChild(option);
                    hpbSpecialCopyButton.disabled = true;
                } else {
                    sourcePages.forEach(([url, name]) => {
                        const option = document.createElement('option');
                        option.value = url;
                        option.textContent = name;
                        copySourceSpecialPageSelect.appendChild(option);
                    });
                    hpbSpecialCopyButton.disabled = false;
                }
            }

            hpbSpecialCopyButton.addEventListener('click', () => {
                const sourceUrl = copySourceSpecialPageSelect.value;
                const destUrl = copyDestSpecialPageUrlInput.value.trim();
                if (!sourceUrl || !destUrl) { alert('ã‚³ãƒ”ãƒ¼å…ƒã¨ã‚³ãƒ”ãƒ¼å…ˆã®ä¸¡æ–¹ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚'); return; }
                if (sourceUrl === destUrl) { alert('ã‚³ãƒ”ãƒ¼å…ƒã¨ã‚³ãƒ”ãƒ¼å…ˆãŒåŒã˜ã§ã™ã€‚'); return; }

                const tasksToCopy = autoTasks.filter(task => task.type === 'special' && task.featurePageUrl === sourceUrl);
                if (!confirm(`ã€Œ${copySourceSpecialPageSelect.options[copySourceSpecialPageSelect.selectedIndex].text}ã€ã®${tasksToCopy.length}å€‹ã®ã‚µãƒ­ãƒ³ã‚’æ–°ã—ã„URLã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã‹ï¼Ÿ`)) { return; }

                tasksToCopy.forEach(task => {
                    const newTaskId = `${task.salonName}-${destUrl}`;
                    if (!autoTasks.some(t => t.id === newTaskId)) {
                        autoTasks.push({ id: newTaskId, type: 'special', salonName: task.salonName, featurePageUrl: destUrl });
                    }
                });
                saveAutoTasks();
                renderAutoTasks();
                alert('ã‚¿ã‚¹ã‚¯ã®ã‚³ãƒ”ãƒ¼ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
                copyDestSpecialPageUrlInput.value = '';
            });

            // --- è‡ªå‹•è¨ˆæ¸¬æ©Ÿèƒ½ ---
            let autoTasks = [];
            let autoRankChart = null;

            const fetchAutoTasks = async () => {
                try {
                    const response = await fetch(`/api/auto-tasks?_=${new Date().getTime()}`);
                    autoTasks = await response.json();
                    updateCopySourceLocations(); // MEOã‚³ãƒ”ãƒ¼å…ƒã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚‚æ›´æ–°
                    updateHpbNormalCopySources(); // HPBé€šå¸¸ã‚³ãƒ”ãƒ¼å…ƒã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚‚æ›´æ–°
                    updateHpbSpecialCopySources(); // HPBç‰¹é›†ã‚³ãƒ”ãƒ¼å…ƒã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚‚æ›´æ–°
                    renderAutoTasks();
                } catch (error) {
                    console.error('è‡ªå‹•è¨ˆæ¸¬ã‚¿ã‚¹ã‚¯ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                }
            };

            const saveAutoTasks = async () => {
                try {
                    await fetch('/api/auto-tasks', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(autoTasks),
                    });
                } catch (error) {
                    console.error('è‡ªå‹•è¨ˆæ¸¬ã‚¿ã‚¹ã‚¯ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                }
            };

            const renderAutoTasks = () => {
                autoTaskList.innerHTML = '';

                // --- æ¤œç´¢ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ã‚¿ã‚¹ã‚¯ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° ---
                // activeãªãƒœã‚¿ãƒ³ãŒãªã„å ´åˆ(åˆæœŸæç”»æ™‚ãªã©)ã‚’è€ƒæ…®
                const activeButton = searchTypeToggle.querySelector('.toggle-button.active');
                if (!activeButton) return;
                const activeSearchType = activeButton.dataset.type;
                const filteredTasks = autoTasks.filter(task => (task.type || 'normal') === activeSearchType);

                if (filteredTasks.length === 0) {
                    autoTaskList.innerHTML = `<li style="padding: 8px 0; color: #6c6c70;">ã“ã®æ¤œç´¢ã‚¿ã‚¤ãƒ—ã®è‡ªå‹•è¨ˆæ¸¬ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>`;
                    selectAllContainer.style.display = 'none';
                    return;
                }
                selectAllContainer.style.display = 'flex'; // blockã‹ã‚‰flexã«å¤‰æ›´
                
                // --- MEOã®å ´åˆã®ã¿ã‚°ãƒ«ãƒ¼ãƒ—åŒ– ---
                if (activeSearchType === 'google') {
                    const groupedTasks = filteredTasks.reduce((acc, task) => {
                        const groupKey = task.searchLocation || 'åœ°ç‚¹æœªè¨­å®š';
                        if (!acc[groupKey]) {
                            acc[groupKey] = [];
                        }
                        acc[groupKey].push(task);
                        return acc;
                    }, {});

                    const sortedGroups = Object.keys(groupedTasks).sort((a, b) => a.localeCompare(b, 'ja'));

                    sortedGroups.forEach(groupKey => {
                        const tasksInGroup = groupedTasks[groupKey];
                        
                        const groupHeader = document.createElement('li');
                        groupHeader.style.padding = '10px 8px';
                        groupHeader.style.backgroundColor = '#f0f0f5';
                        groupHeader.style.fontWeight = '600';
                        groupHeader.style.marginTop = '10px';
                        groupHeader.style.borderRadius = '6px';
                        groupHeader.style.display = 'flex';
                        groupHeader.style.alignItems = 'center';

                        const groupCheckbox = document.createElement('input');
                        groupCheckbox.type = 'checkbox';
                        groupCheckbox.style.marginRight = '10px';
                        groupCheckbox.dataset.groupKey = groupKey;
                        groupHeader.appendChild(groupCheckbox);

                        const groupLabel = document.createElement('label');
                        groupLabel.textContent = groupKey;
                        groupLabel.style.cursor = 'pointer';
                        groupLabel.style.flexGrow = '1'; // ã“ã®è¡Œã¯å¤‰æ›´ãªã—
                        groupHeader.appendChild(groupLabel);

                        autoTaskList.appendChild(groupHeader);

                        const taskUl = document.createElement('ul');
                        taskUl.style.listStyle = 'none';
                        taskUl.style.paddingLeft = '20px';
                        autoTaskList.appendChild(taskUl);

                        tasksInGroup.sort((a, b) => (a.keyword || '').localeCompare(b.keyword || '', 'ja'));

                        tasksInGroup.forEach(task => {
                            renderTaskItem(task, taskUl, groupKey);
                        });

                        groupCheckbox.addEventListener('change', (e) => {
                            const isChecked = e.target.checked;
                            const key = e.target.dataset.groupKey;
                            taskUl.querySelectorAll(`.auto-task-checkbox[data-group-key="${key}"]`).forEach(cb => {
                                cb.checked = isChecked;
                            });
                        });
                    });
                } else if (activeSearchType === 'normal') { // HPBé€šå¸¸æ¤œç´¢ã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚’è¿½åŠ 
                    const groupedTasks = filteredTasks.reduce((acc, task) => {
                        const groupKey = task.areaName || 'ã‚¨ãƒªã‚¢æœªè¨­å®š';
                        if (!acc[groupKey]) {
                            acc[groupKey] = [];
                        }
                        acc[groupKey].push(task);
                        return acc;
                    }, {});

                    const sortedGroups = Object.keys(groupedTasks).sort((a, b) => a.localeCompare(b, 'ja'));

                    sortedGroups.forEach(groupKey => {
                        const tasksInGroup = groupedTasks[groupKey];
                        
                        const groupHeader = document.createElement('li');
                        groupHeader.style.padding = '10px 8px';
                        groupHeader.style.backgroundColor = '#f0f0f5';
                        groupHeader.style.fontWeight = '600';
                        groupHeader.style.marginTop = '10px';
                        groupHeader.style.borderRadius = '6px';
                        groupHeader.style.display = 'flex';
                        groupHeader.style.alignItems = 'center';

                        const groupCheckbox = document.createElement('input');
                        groupCheckbox.type = 'checkbox';
                        groupCheckbox.style.marginRight = '10px';
                        groupCheckbox.dataset.groupKey = groupKey;
                        groupHeader.appendChild(groupCheckbox);

                        const groupLabel = document.createElement('label');
                        groupLabel.textContent = groupKey;
                        groupLabel.style.cursor = 'pointer';
                        groupLabel.style.flexGrow = '1'; // ã“ã®è¡Œã¯å¤‰æ›´ãªã—
                        groupLabel.onclick = () => groupCheckbox.click();
                        groupHeader.appendChild(groupLabel);

                        autoTaskList.appendChild(groupHeader);

                        tasksInGroup.sort((a, b) => (a.serviceKeyword || '').localeCompare(b.serviceKeyword || '', 'ja'));
                        tasksInGroup.forEach(task => renderTaskItem(task, autoTaskList, groupKey)); // ã“ã®è¡Œã¯å¤‰æ›´ãªã—
                    });
                } else if (activeSearchType === 'special') { // HPBç‰¹é›†æ¤œç´¢ã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚’è¿½åŠ 
                    const groupedTasks = filteredTasks.reduce((acc, task) => {
                        // ã‚°ãƒ«ãƒ¼ãƒ—ã‚­ãƒ¼ã«ã¯URLã‚’ä½¿ç”¨ã—ã€è¡¨ç¤ºåã¨ã—ã¦ã‚¿ã‚¤ãƒˆãƒ«(featurePageName)ã¾ãŸã¯URLã‚’ä¿æŒ
                        const groupKey = task.featurePageUrl;
                        const groupDisplayName = task.featurePageName || task.featurePageUrl;
                        if (!acc[groupKey]) {
                            acc[groupKey] = { displayName: groupDisplayName, tasks: [] };
                        }
                        acc[groupKey].tasks.push(task);
                        // ã‚°ãƒ«ãƒ¼ãƒ—å†…ã§æœ€ã‚‚æ–°ã—ã„ã‚¿ã‚¤ãƒˆãƒ«ã‚’displayNameã¨ã—ã¦æ¡ç”¨
                        if (task.featurePageName) {
                            acc[groupKey].displayName = task.featurePageName;
                        }
                        return acc;
                    }, {});

                    const sortedGroups = Object.entries(groupedTasks).sort((a, b) => a[1].displayName.localeCompare(b[1].displayName, 'ja'));

                    sortedGroups.forEach(([groupKey, groupData]) => {
                        const tasksInGroup = groupData.tasks;

                        const groupHeader = document.createElement('li');
                        groupHeader.style.padding = '10px 8px';
                        groupHeader.style.backgroundColor = '#f0f0f5';
                        groupHeader.style.fontWeight = '600';
                        groupHeader.style.marginTop = '10px';
                        groupHeader.style.borderRadius = '6px';
                        groupHeader.style.display = 'flex';
                        groupHeader.style.alignItems = 'center';

                        const groupCheckbox = document.createElement('input');
                        groupCheckbox.type = 'checkbox';
                        groupCheckbox.style.marginRight = '10px';
                        groupCheckbox.dataset.groupKey = groupKey; // ã‚°ãƒ«ãƒ¼ãƒ—ã‚­ãƒ¼ã¨ã—ã¦URLã‚’ä½¿ç”¨
                        groupHeader.appendChild(groupCheckbox);

                        const groupLabel = document.createElement('label');
                        groupLabel.textContent = groupData.displayName; // è¡¨ç¤ºåã‚’ä½¿ç”¨
                        groupLabel.style.cursor = 'pointer';
                        groupLabel.style.flexGrow = '1';
                        groupLabel.onclick = () => groupCheckbox.click();
                        groupHeader.appendChild(groupLabel);

                        autoTaskList.appendChild(groupHeader);

                        tasksInGroup.sort((a, b) => (a.salonName || '').localeCompare(b.salonName || '', 'ja'));
                        tasksInGroup.forEach(task => renderTaskItem(task, autoTaskList, groupKey));
                    });
                } else { // ç‰¹é›†ãƒšãƒ¼ã‚¸ã®å ´åˆ (ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ãªã—)
                    // ã‚½ãƒ¼ãƒˆã—ã¦è¡¨ç¤º
                    filteredTasks.sort((a, b) => (a.id).localeCompare(b.id, 'ja'));
                    filteredTasks.forEach(task => {
                        renderTaskItem(task, autoTaskList);
                    });
                }
            };

            function renderTaskItem(task, parentElement, groupKey = null) {
                const taskType = task.type || 'normal';

                const li = document.createElement('li');
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.style.alignItems = 'center';
                li.style.padding = '8px 0';
                li.style.borderBottom = '1px solid #eee';
                li.style.wordBreak = 'break-all';

                // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’è¿½åŠ 
                if (groupKey) {
                    li.style.paddingLeft = '20px';
                }

                const taskLabel = document.createElement('label');
                taskLabel.style.display = 'flex';
                taskLabel.style.alignItems = 'center';
                taskLabel.style.flexGrow = '1';
                taskLabel.style.cursor = 'pointer';
                taskLabel.style.marginRight = '10px';
                // ã‚°ãƒ«ãƒ¼ãƒ—ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¨é€£å‹•ã•ã›ã‚‹ãŸã‚ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
                taskLabel.onclick = (e) => { if (e.target.tagName !== 'INPUT') checkbox.click(); };

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'auto-task-checkbox';
                checkbox.value = task.id;
                if (groupKey) {
                    checkbox.dataset.groupKey = groupKey;
                }
                checkbox.style.marginRight = '10px';
                
                const taskText = document.createElement('span');
                if (taskType === 'normal') {
                    taskText.textContent = `${task.serviceKeyword} - ${task.salonName}`;
                } else if (taskType === 'special') {
                    taskText.textContent = `${task.salonName}`; // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚ŒãŸã®ã§ã‚µãƒ­ãƒ³åã®ã¿è¡¨ç¤º
                } else if (taskType === 'google') {
                    taskText.textContent = `${task.keyword} - ${task.salonName}`;
                }

                taskLabel.appendChild(checkbox);
                taskLabel.appendChild(taskText);
                li.appendChild(taskLabel);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'å‰Šé™¤';
                deleteButton.className = 'button-secondary';
                deleteButton.style.padding = '4px 8px';
                deleteButton.style.fontSize = '13px';
                deleteButton.style.flexShrink = '0';
                deleteButton.onclick = () => {
                    if (confirm(`ã€Œ${taskText.textContent}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        autoTasks = autoTasks.filter(t => t.id !== task.id);
                        saveAutoTasks();
                        renderAutoTasks();
                        fetchAndDisplayAutoHistory();
                    }
                };
                li.appendChild(deleteButton);
                parentElement.appendChild(li);

                // ã‚°ãƒ«ãƒ¼ãƒ—ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                if (groupKey) {
                    const groupCheckbox = document.querySelector(`input[type="checkbox"][data-group-key="${groupKey}"]`);
                    if (groupCheckbox) {
                        groupCheckbox.addEventListener('change', (e) => {
                            const isChecked = e.target.checked; // ã“ã®è¡Œã¯å¤‰æ›´ãªã—
                            const key = e.target.dataset.groupKey;
                            // åŒã˜è¦ªè¦ç´ å†…ã®ã€åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—ã‚­ãƒ¼ã‚’æŒã¤ã‚¿ã‚¹ã‚¯ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’åŒæœŸ
                            parentElement.querySelectorAll(`.auto-task-checkbox[data-group-key="${key}"]`).forEach(cb => {
                                cb.checked = isChecked;
                            });
                        });
                    }
                }
            };

            addAutoTaskButton.addEventListener('click', () => {
                const activeSearchType = searchTypeToggle.querySelector('.toggle-button.active').dataset.type;
                const salonName = salonNameInput.value.trim();

                let addedTasks = [];
                let existingTasks = [];

                if (activeSearchType === 'normal') {
                    const largeArea = largeAreaSelect.value;
                    const serviceKeywords = keywordInput.value.trim().split(/[\s,ã€]+/).filter(k => k);

                    if (!largeArea || serviceKeywords.length === 0) {
                        alert('ã‚¨ãƒªã‚¢ãƒ–ãƒ­ãƒƒã‚¯ã¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }

                    if (!salonName) {
                        alert('ã‚µãƒ­ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }

                    const middleArea = middleAreaSelect.value; // ä¸­ã‚¨ãƒªã‚¢ã®å€¤ã‚’å–å¾—
                    const smallArea = smallAreaSelect.value; // å°ã‚¨ãƒªã‚¢ã®å€¤ã‚’å–å¾—
                    const areaCodes = {};
                    if (largeArea) areaCodes.serviceAreaCd = areas[largeArea].code; // å¤§ã‚¨ãƒªã‚¢ã‚³ãƒ¼ãƒ‰
                    if (middleArea) areaCodes.middleAreaCd = areas[largeArea].middleAreas[middleArea].code; // ä¸­ã‚¨ãƒªã‚¢ã‚³ãƒ¼ãƒ‰
                    // å°ã‚¨ãƒªã‚¢ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ 
                    if (smallArea) areaCodes.smallAreaCd = areas[largeArea].middleAreas[middleArea].smallAreas[smallArea].code;

                    // è¡¨ç¤ºç”¨ã®ã‚¨ãƒªã‚¢åã¯ã€æœ€ã‚‚è©³ç´°ãªã‚¨ãƒªã‚¢åã‚’ä½¿ç”¨
                    const areaName = smallArea || middleArea || largeArea; 

                    serviceKeywords.forEach(keyword => {
                        const taskId = `${salonName}-${areaName}-${keyword}`;
                        if (autoTasks.some(t => t.id === taskId)) {
                            existingTasks.push(keyword);
                        } else {
                            autoTasks.push({ id: taskId, type: 'normal', salonName, areaName, areaCodes, serviceKeyword: keyword });
                            addedTasks.push(keyword);
                        }
                    });
                } else if (activeSearchType === 'special') { // special
                    const featureUrl = featurePageUrlInput.value.trim();
                    if (!featureUrl) {
                        alert('ç‰¹é›†ãƒšãƒ¼ã‚¸ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    if (!salonName) {
                        alert('ã‚µãƒ­ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }

                    const taskId = `${salonName}-${featureUrl}`;
                    if (autoTasks.some(t => t.id === taskId)) {
                        existingTasks.push(featureUrl);
                    } else {
                        // featurePageNameã¯åˆå›è¨ˆæ¸¬æ™‚ã«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§è¨­å®šã•ã‚Œã‚‹
                        autoTasks.push({ id: taskId, type: 'special', salonName, featurePageUrl: featureUrl });
                        addedTasks.push(featureUrl);
                    }
                } else if (activeSearchType === 'google') { // google
                    const searchLocation = document.getElementById('searchLocationInput').value.trim();
                    const googleKeyword = document.getElementById('googleKeywordInput').value.trim();
                    if (!searchLocation || !googleKeyword) {
                        alert('æ¤œç´¢åœ°ç‚¹ã¨æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    if (!salonName) {
                        alert('ã‚µãƒ­ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }

                    // --- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è‡ªå‹•æ•´å½¢æ©Ÿèƒ½ ---
                    // æ¤œç´¢åœ°ç‚¹åã‹ã‚‰ã€Œé§…ã€ã‚„ã€Œå¸‚ã€ã‚’å–ã‚Šé™¤ãï¼ˆä¾‹: "ç¦å±±é§…" -> "ç¦å±±"ï¼‰
                    const locationBaseName = searchLocation.replace(/é§…|å¸‚$/, '').trim();
                    let cleanedKeyword = googleKeyword;
                    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã€Œåœ°å ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€ã®å½¢å¼ã‹ãƒã‚§ãƒƒã‚¯
                    if (locationBaseName && cleanedKeyword.startsWith(locationBaseName)) {
                        // åœ°åéƒ¨åˆ†ã¨ã€ãã‚Œã«ç¶šãå¯èƒ½æ€§ã®ã‚ã‚‹ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤
                        cleanedKeyword = googleKeyword.substring(locationBaseName.length).trim();
                        console.log(`ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è‡ªå‹•æ•´å½¢ã—ã¾ã—ãŸ: "${googleKeyword}" -> "${cleanedKeyword}"`);
                    }

                    const taskId = `[google]-${salonName}-${searchLocation}-${cleanedKeyword}`;
                    if (autoTasks.some(t => t.id === taskId)) {
                        existingTasks.push(`[${searchLocation}] ${cleanedKeyword}`);
                    } else {
                        autoTasks.push({ id: taskId, type: 'google', salonName, searchLocation, keyword: cleanedKeyword });
                        addedTasks.push(`[${searchLocation}] ${cleanedKeyword}`);
                    }
                }

                if (addedTasks.length > 0) {
                    saveAutoTasks();
                    renderAutoTasks();
                    alert(`ä»¥ä¸‹ã®ã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•è¨ˆæ¸¬ã«è¿½åŠ ã—ã¾ã—ãŸ:\n- ${addedTasks.join('\n- ')}`);
                }

                if (existingTasks.length > 0) {
                    alert(`ä»¥ä¸‹ã®ã‚¿ã‚¹ã‚¯ã¯æ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™:\n- ${existingTasks.join('\n- ')}`);
                }
            });

            selectAllCheckbox.addEventListener('change', (e) => {
                autoTaskList.querySelectorAll('.auto-task-checkbox').forEach(cb => {
                    cb.checked = e.target.checked;
                });
            });

            manualTriggerButton.addEventListener('click', async () => {
                const selectedCheckboxes = autoTaskList.querySelectorAll('.auto-task-checkbox:checked');
                const selectedTaskIds = new Set(Array.from(selectedCheckboxes).map(cb => cb.value));

                if (selectedTaskIds.size === 0) {
                    alert('å®Ÿè¡Œã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’å°‘ãªãã¨ã‚‚1ã¤é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                if (!confirm(`é¸æŠã—ãŸ ${selectedTaskIds.size} ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’ä»Šã™ãå®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ`)) {
                    return;
                }

                // å®Ÿè¡Œå¯¾è±¡ã®ã‚¿ã‚¹ã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
                const tasksToRun = autoTasks.filter(task => selectedTaskIds.has(task.id));

                setMeasuringState(true); // è¨ˆæ¸¬çŠ¶æ…‹ã‚’é–‹å§‹ã«è¨­å®š
                manualTriggerButton.textContent = 'å®Ÿè¡Œä¸­...';

                // --- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã®æº–å‚™ ---
                resultArea.innerHTML = ''; // çµæœã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
                const overallStatusContainer = document.createElement('div');
                overallStatusContainer.id = 'overallStatus';
                overallStatusContainer.style.padding = '10px';
                overallStatusContainer.style.marginBottom = '15px';
                overallStatusContainer.style.fontWeight = '500';
                resultArea.appendChild(overallStatusContainer);

                overallStatusContainer.textContent = `é¸æŠã•ã‚ŒãŸ ${selectedTaskIds.size} ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™...`;

                // --- æ‰€è¦æ™‚é–“è¨ˆæ¸¬é–‹å§‹ ---
                const startTime = performance.now();
                let timerInterval = null;

                // --- å‡¦ç†ã‚’é€šå¸¸æ¤œç´¢ã¨ç‰¹é›†ãƒšãƒ¼ã‚¸æ¤œç´¢ã«åˆ†å‰² ---
                const normalTaskIds = tasksToRun
                    .filter(t => (t.type || 'normal') === 'normal')
                    .map(t => t.id);

                const specialTaskIds = tasksToRun // ç‰¹é›†ãƒšãƒ¼ã‚¸ã‚¿ã‚¹ã‚¯
                    .filter(t => t.type === 'special')
                    .map(t => t.id);

                const meoTaskIds = tasksToRun // MEOã‚¿ã‚¹ã‚¯
                    .filter(t => t.type === 'google')
                    .map(t => t.id);

                // --- çµŒéæ™‚é–“è¡¨ç¤ºã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹ ---
                timerInterval = setInterval(() => {
                    const elapsedTotalSeconds = Math.floor((performance.now() - startTime) / 1000);
                    const minutes = Math.floor(elapsedTotalSeconds / 60);
                    const seconds = elapsedTotalSeconds % 60;
                    const durationString = minutes > 0 ? `${minutes}åˆ†${seconds}ç§’` : `${seconds}ç§’`;
                    const currentText = overallStatusContainer.textContent;
                    // æœ€å¾Œã®æ‹¬å¼§éƒ¨åˆ†ã‚’æ™‚é–“è¡¨ç¤ºã§ç½®ãæ›ãˆã‚‹
                    const baseText = currentText.replace(/\s*\([^)]*\)$/, '');
                    if (baseText && !baseText.includes('å®Œäº†')) { // è¨ˆæ¸¬å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã¯è¿½è¨˜ã—ãªã„
                        overallStatusContainer.textContent = `${baseText} (çµŒéæ™‚é–“: ${durationString})`;
                    }
                }, 1000);

                const promises = [];

                // --- æ±ç”¨çš„ãªã‚¹ãƒˆãƒªãƒ¼ãƒ å‡¦ç†é–¢æ•° ---
                const processStream = (taskIds) => {
                    if (taskIds.length === 0) {
                        return Promise.resolve();
                    }

                    return new Promise((resolve, reject) => {
                        const params = new URLSearchParams({ task_ids: JSON.stringify(taskIds) });
                        const eventSource = new EventSource(`/api/run-tasks-manually?${params.toString()}`);

                        eventSource.onmessage = (event) => {
                            const data = JSON.parse(event.data);

                            if (data.error) {
                                const errorContainer = document.createElement('div');
                                errorContainer.innerHTML = `<p style="color: red;">ã‚¨ãƒ©ãƒ¼: ${data.error}</p>`;
                                resultArea.appendChild(errorContainer);
                                eventSource.close();
                                reject(new Error(data.error));
                                return;
                            }

                            if (data.progress) {
                                const { current, total, task } = data.progress;

                                // --- å…¨ä½“ã®é€²æ—çŠ¶æ³ã‚’æ›´æ–° ---
                                let taskNameForStatus = '';
                                if (task.type === 'special') {
                                    taskNameForStatus = task.featurePageName || task.featurePageUrl;
                                } else if (task.type === 'google') {
                                    taskNameForStatus = `[${task.searchLocation}] ${task.keyword}`;
                                } else { // normal
                                    taskNameForStatus = `[${task.areaName}] ${task.serviceKeyword}`;
                                }
                                
                                const overallStatusContainer = document.getElementById('overallStatus');
                                if (overallStatusContainer) {
                                    overallStatusContainer.textContent = `${current} / ${total} ä»¶ç›®: ã€Œ${taskNameForStatus}ã€ã‚’è¨ˆæ¸¬ä¸­... `; // æœ«å°¾ã«ã‚¹ãƒšãƒ¼ã‚¹
                                }
                                // --- ã“ã“ã¾ã§è¿½åŠ  ---
                                
                                if (task.type === 'special') {
                                    // ç‰¹é›†ãƒšãƒ¼ã‚¸ã®å ´åˆ
                                    const tasksInGroup = tasksToRun.filter(t => t.featurePageUrl === task.featurePageUrl);
                                    tasksInGroup.forEach(groupTask => {
                                        const taskId = groupTask.id;
                                        const fullKeyword = `[${groupTask.salonName}] ${groupTask.featurePageName || groupTask.featurePageUrl}`;
                                        const taskContainer = document.createElement('div');
                                        taskContainer.id = `task-container-${taskId}`;
                                        taskContainer.style.borderBottom = '1px solid #e5e5e7';
                                        taskContainer.style.paddingBottom = '15px';
                                        taskContainer.style.marginBottom = '15px';
                                        taskContainer.innerHTML = `<h4 style="margin-top:0; margin-bottom: 10px;">ã€Œ${fullKeyword}ã€</h4><p>è¨ˆæ¸¬ã‚’é–‹å§‹ã—ã¾ã™...</p>`;
                                        resultArea.appendChild(taskContainer);
                                    });
                                } else if (task.type === 'google') {
                                    // MEOã®å ´åˆ
                                    const taskId = task.id;
                                    const fullKeyword = `[${task.searchLocation}] ${task.keyword}`;
                                    const taskContainer = document.createElement('div');
                                    taskContainer.id = `task-container-${taskId}`;
                                    taskContainer.style.borderBottom = '1px solid #e5e5e7';
                                    taskContainer.style.paddingBottom = '15px';
                                    taskContainer.style.marginBottom = '15px';
                                    taskContainer.innerHTML = `<h4 style="margin-top:0; margin-bottom: 10px;">ã€Œ${fullKeyword}ã€</h4><p>è¨ˆæ¸¬ã‚’é–‹å§‹ã—ã¾ã™...</p>`;
                                    resultArea.appendChild(taskContainer);
                                } else {
                                    const taskId = task.id;
                                    const fullKeyword = `[${task.areaName}] ${task.serviceKeyword}`;
                                    const taskContainer = document.createElement('div');
                                    taskContainer.id = `task-container-${taskId}`;
                                    taskContainer.style.borderBottom = '1px solid #e5e5e7';
                                    taskContainer.style.paddingBottom = '15px';
                                    taskContainer.style.marginBottom = '15px';
                                    taskContainer.innerHTML = `<h4 style="margin-top:0; margin-bottom: 10px;">ã€Œ${fullKeyword}ã€</h4><p>è¨ˆæ¸¬ã‚’é–‹å§‹ã—ã¾ã™...</p>`;
                                    resultArea.appendChild(taskContainer);
                                }
                            }

                            if (data.status) {
                                // statusã‚¤ãƒ™ãƒ³ãƒˆã¯ç‰¹å®šã®ã‚¿ã‚¹ã‚¯IDã«ç´ä»˜ã‹ãªã„å ´åˆãŒã‚ã‚‹ãŸã‚ã€æœ€å¾Œã®ã‚³ãƒ³ãƒ†ãƒŠã‚’æ›´æ–°
                                const lastContainer = resultArea.querySelector('div:last-of-type');
                                if (lastContainer) {
                                    lastContainer.innerHTML = `<h4 style="margin-top:0; margin-bottom: 10px;">ã€Œ${data.task_name}ã€</h4><p>${data.status}</p>`;
                                }
                            }

                            if (data.result) {
                                const { rank, total_count, task_name, task_id } = data.result;
                                const taskContainer = document.getElementById(`task-container-${task_id}`);
                                if (!taskContainer) return; // å¯¾å¿œã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠãŒãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
                                const totalCountHtml = (total_count !== undefined) ? `<p style="font-size: 14px; color: #6c6c70; margin-bottom: 10px;">æ¤œç´¢çµæœç·æ•°: <strong style="color: #1c1c1e;">${total_count}</strong> ä»¶</p>` : '';
                                const resultMessageHtml = `<p style="margin: 0; font-size: 18px; font-weight: bold;"><span style="color: #007aff; font-size: 1.3em;">${rank}</span> ä½</p>`;
                                taskContainer.innerHTML = `<h4 style="margin-top:0; margin-bottom: 10px;">ã€Œ${task_name}ã€</h4>${totalCountHtml}${resultMessageHtml}`;
                            }

                            if (data.final_status) {
                                eventSource.close();
                                resolve(); // ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒå®Œäº†ã—ãŸã‚‰Promiseã‚’è§£æ±º
                            }
                        };

                        eventSource.onerror = (err) => {
                            console.error("EventSource failed:", err);
                            const errorContainer = document.createElement('div');
                            errorContainer.innerHTML = `<p style="color: red;">ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>`;
                            resultArea.appendChild(errorContainer);
                            eventSource.close();
                            reject(err);
                        }
                    });
                }

                // å„ã‚¿ã‚¤ãƒ—ã®ã‚¿ã‚¹ã‚¯ã‚’ãã‚Œãã‚Œï¼ˆä¸¦è¡Œã—ã¦ï¼‰å®Ÿè¡Œ
                promises.push(processStream(normalTaskIds));
                promises.push(processStream(specialTaskIds));
                promises.push(processStream(meoTaskIds));

                try {
                    // ã™ã¹ã¦ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ å‡¦ç†ãŒçµ‚ã‚ã‚‹ã®ã‚’å¾…ã¤
                    await Promise.all(promises);
                    // --- ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢ ---
                    clearInterval(timerInterval);
                    // --- æ‰€è¦æ™‚é–“è¨ˆæ¸¬çµ‚äº† ---
                    const endTime = performance.now();
                    const elapsedTotalSeconds = Math.floor((endTime - startTime) / 1000);
                    const minutes = Math.floor(elapsedTotalSeconds / 60);
                    const seconds = elapsedTotalSeconds % 60;
                    const durationString = minutes > 0 ? `${minutes}åˆ†${seconds}ç§’` : `${seconds}ç§’`;
                    overallStatusContainer.textContent = `ã™ã¹ã¦ã®è¨ˆæ¸¬ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ï¼ˆ${selectedTaskIds.size}ä»¶ / æ‰€è¦æ™‚é–“: ${durationString}ï¼‰`;
                } catch (error) {
                    console.error('æ‰‹å‹•å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                    const endTime = performance.now();
                    const elapsedTotalSeconds = Math.floor((endTime - startTime) / 1000);
                    const minutes = Math.floor(elapsedTotalSeconds / 60);
                    const seconds = elapsedTotalSeconds % 60;
                    const durationString = minutes > 0 ? `${minutes}åˆ†${seconds}ç§’` : `${seconds}ç§’`;
                    // --- ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢ ---
                    clearInterval(timerInterval);
                    overallStatusContainer.textContent = `è¨ˆæ¸¬ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ï¼ˆæ‰€è¦æ™‚é–“: ${durationString}ï¼‰è©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
                } finally {
                    // å…¨ã¦ã®å‡¦ç†ãŒçµ‚ã‚ã£ãŸã‚‰ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                    setMeasuringState(false);
                    manualTriggerButton.textContent = 'é¸æŠã—ãŸã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œ';
                    fetchAndDisplayAutoHistory(); // ã‚°ãƒ©ãƒ•ã‚’æœ€æ–°ã®çŠ¶æ…‹ã«æ›´æ–°
                }
            });

            const fetchAndDisplayAutoHistory = async () => {
                try {
                    const response = await fetch(`/api/auto-history?_=${new Date().getTime()}`);
                    const historyData = await response.json();

                    const autoHistoryContainer = document.getElementById('autoHistoryContainer');
                    const autoHistoryGraphs = document.getElementById('autoHistoryGraphs');

                    if (!historyData || historyData.length === 0) {
                        autoHistoryContainer.style.display = 'none';
                        noAutoHistoryMessage.style.display = 'block';
                        if (autoHistoryGraphs) autoHistoryGraphs.innerHTML = ''; // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
                        return;
                    }

                    autoHistoryContainer.style.display = 'block';
                    noAutoHistoryMessage.style.display = 'none';

                    // ã‚°ãƒ©ãƒ•ã‚’æç”»ã™ã‚‹å‰ã«ã€ã‚³ãƒ³ãƒ†ãƒŠã®ä¸­èº«ã‚’ä¸€åº¦ç©ºã«ã™ã‚‹
                    autoHistoryGraphs.innerHTML = '';

                    // --- æ¤œç´¢ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦å±¥æ­´ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼†ã‚°ãƒ«ãƒ¼ãƒ—åŒ– ---
                    const activeSearchType = searchTypeToggle.querySelector('.toggle-button.active').dataset.type;
                    const filteredHistory = historyData.filter(item => (item.task.type || 'normal') === activeSearchType);

                    if (filteredHistory.length === 0) {
                        autoHistoryContainer.style.display = 'none';
                        noAutoHistoryMessage.style.display = 'block';
                        noAutoHistoryMessage.textContent = 'ã“ã®æ¤œç´¢ã‚¿ã‚¤ãƒ—ã®å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
                        return;
                    }

                    const groupedHistory = filteredHistory.reduce((acc, historyItem) => {
                        let groupKey;
                        if (activeSearchType === 'normal') {
                            groupKey = `${historyItem.task.areaName} - ${historyItem.task.salonName}`;
                        } else if (activeSearchType === 'special') { // special
                            // ç‰¹é›†ãƒšãƒ¼ã‚¸ã¯ã€ãƒšãƒ¼ã‚¸ã®ã‚¿ã‚¤ãƒˆãƒ«ã¾ãŸã¯URLã®ã¿ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã™ã‚‹
                            groupKey = historyItem.task.featurePageName || historyItem.task.featurePageUrl;
                        } else if (activeSearchType === 'google') {
                            // MEOã¯ã€æ¤œç´¢åœ°ç‚¹ã¨ã‚µãƒ­ãƒ³åã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã™ã‚‹
                            groupKey = `${historyItem.task.searchLocation} - ${historyItem.task.salonName}`;
                        }
                        
                        if (!acc[groupKey]) { 
                            acc[groupKey] = []; 
                        }
                        acc[groupKey].push(historyItem);
                        return acc;
                    }, {});

                    // --- ã‚°ãƒ©ãƒ•ã®è¡¨ç¤ºé †ã‚’ã‚°ãƒ«ãƒ¼ãƒ—ã‚­ãƒ¼ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼‰ã®ã‚ã„ã†ãˆãŠé †ã«ã‚½ãƒ¼ãƒˆ ---
                    const sortedGroupedHistory = Object.entries(groupedHistory).sort((a, b) => a[0].localeCompare(b[0], 'ja'));

                    // --- ä¿å­˜ã•ã‚ŒãŸé †åºã§ã‚½ãƒ¼ãƒˆã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ  ---
                    const savedOrder = JSON.parse(localStorage.getItem(`graphOrder_${activeSearchType}`) || '[]');
                    const sortedWithSavedOrder = Object.entries(groupedHistory).sort((a, b) => {
                        const indexA = savedOrder.indexOf(a[0]);
                        const indexB = savedOrder.indexOf(b[0]);

                        if (indexA !== -1 && indexB !== -1) {
                            return indexA - indexB; // ä¸¡æ–¹ã¨ã‚‚ä¿å­˜ã•ã‚Œã¦ã„ã‚Œã°ãã®é †
                        } else if (indexA !== -1) {
                            return -1; // Aã ã‘ä¿å­˜ã•ã‚Œã¦ã„ã‚Œã°AãŒå…ˆ
                        } else if (indexB !== -1) {
                            return 1; // Bã ã‘ä¿å­˜ã•ã‚Œã¦ã„ã‚Œã°BãŒå…ˆ
                        }
                        return a[0].localeCompare(b[0], 'ja'); // ã©ã¡ã‚‰ã‚‚ä¿å­˜ã•ã‚Œã¦ã„ãªã‘ã‚Œã°åå‰é †
                    });

                    sortedWithSavedOrder.forEach(([groupKey, groupData]) => {
                        // --- ç‰¹å®šã®ã‚µãƒ­ãƒ³ã‚’ã‚°ãƒ©ãƒ•ãƒ»è¡¨ã‹ã‚‰é™¤å¤–ã™ã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° ---
                        const exclusionList = {
                            "åºƒå³¶å¸‚ä¸­åŒºã§ã¾ã¤ã’ãƒ‘ãƒ¼ãƒãŒäººæ°—ã®ã¾ã¤ã’ã‚µãƒ­ãƒ³": ["elua æ¨ªå·åº—", "elua ç·‘äº•åº—"]
                        };

                        if (exclusionList[groupKey]) {
                            groupData = groupData.filter(taskData => 
                                !exclusionList[groupKey].includes(taskData.task.salonName)
                            );
                        }
                        const graphWrapper = document.createElement('div');
                        graphWrapper.className = 'graph-wrapper';
                        graphWrapper.dataset.groupKey = groupKey;
                        graphWrapper.style.position = 'relative'; // ã‚°ãƒ©ãƒ•ã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤ºã«å¿…è¦
                        graphWrapper.style.height = 'auto'; // é«˜ã•ã‚’è‡ªå‹•èª¿æ•´ã«å¤‰æ›´
                        graphWrapper.style.marginBottom = '40px';

                        const headerContainer = document.createElement('div');
                        headerContainer.style.display = 'flex';
                        headerContainer.style.justifyContent = 'space-between';
                        headerContainer.style.alignItems = 'center';
                        headerContainer.style.borderBottom = '1px solid #e5e5e7';
                        headerContainer.style.paddingBottom = '8px';
                        headerContainer.style.marginBottom = '15px';

                        const header = document.createElement('h5');
                        header.textContent = groupKey;
                        header.style.fontSize = '16px';
                        header.style.fontWeight = '600';
                        header.style.margin = 0; // h5ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ã‚¸ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
                        headerContainer.appendChild(header);

                        // --- ä¸¦ã³æ›¿ãˆãƒœã‚¿ãƒ³ã‚’è¿½åŠ  ---
                        const controls = document.createElement('div');
                        controls.className = 'graph-controls';
                        const upButton = document.createElement('button');
                        upButton.textContent = 'â†‘';
                        upButton.onclick = () => moveGraph(graphWrapper, 'up');
                        const downButton = document.createElement('button');
                        downButton.textContent = 'â†“';
                        downButton.onclick = () => moveGraph(graphWrapper, 'down');
                        
                        const excelButton = document.createElement('button');
                        excelButton.textContent = 'Excelå‡ºåŠ›';
                        excelButton.className = 'excel-button'; // ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨ã®ãŸã‚ã‚¯ãƒ©ã‚¹è¿½åŠ 
                        excelButton.onclick = () => exportToCsv(groupKey, groupData, activeSearchType);

                        controls.appendChild(upButton);
                        controls.appendChild(downButton);
                        controls.appendChild(excelButton);
                        headerContainer.appendChild(controls);

                        graphWrapper.appendChild(headerContainer);

                        const canvasContainer = document.createElement('div'); // canvasã‚’å›²ã‚€divã‚’è¿½åŠ 
                        canvasContainer.style.height = '220px'; // ã‚°ãƒ©ãƒ•ã®é«˜ã•ã¯ã“ã“ã§æŒ‡å®š

                        const canvas = document.createElement('canvas');
                        canvasContainer.appendChild(canvas); // canvasã‚’ã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã‚Œã‚‹
                        graphWrapper.appendChild(canvasContainer); // ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ©ãƒƒãƒ‘ãƒ¼ã«å…¥ã‚Œã‚‹
                        autoHistoryGraphs.appendChild(graphWrapper);

                        const allDates = new Set();
                        groupData.forEach(task => task.log.forEach(entry => allDates.add(entry.date)));
                        const sortedLabels = Array.from(allDates).sort((a, b) => new Date(a) - new Date(b));
                        
                        // --- å‡¡ä¾‹ã‚’ã€Œã‚ã„ã†ãˆãŠé †ã€ã«ã‚½ãƒ¼ãƒˆ ---
                        groupData.sort((a, b) => {
                            let labelA = '';
                            let labelB = '';
                            if (activeSearchType === 'normal') {
                                labelA = a.task.serviceKeyword;
                                labelB = b.task.serviceKeyword;
                            } else if (activeSearchType === 'google') {
                                labelA = a.task.keyword;
                                labelB = b.task.keyword;
                            }
                            return labelA.localeCompare(labelB, 'ja');
                        });

                        // groupDataï¼ˆã‚¿ã‚¹ã‚¯ã®ãƒªã‚¹ãƒˆï¼‰ã‹ã‚‰ã€ã‚°ãƒ©ãƒ•ç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½œæˆã—ã¾ã™
                        const datasets = groupData.map((taskData, index) => {
                            // æ—¥ä»˜ã‚’ã‚­ãƒ¼ã¨ã—ã¦ã€rankã¨screenshotã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’Mapã«ä¿å­˜
                            const dataMap = new Map(taskData.log.map(entry => [entry.date, { rank: entry.rank, screenshot: entry.screenshot }]));
                            const dataForChart = sortedLabels.map((date, dateIndex) => {
                                const entry = dataMap.get(date);
                                if (entry !== undefined) {
                                    // originalRankã«åŠ ãˆã¦screenshotã®ãƒ‘ã‚¹ã‚‚rawãƒ‡ãƒ¼ã‚¿ã«å«ã‚ã‚‹
                                    return { x: date, y: convertRankToY(entry.rank), originalRank: entry.rank, screenshot: entry.screenshot };
                                }
                                return { x: date, y: NaN }; // nullã®ä»£ã‚ã‚Šã«NaNã‚’ä½¿ç”¨
                            });

                            let labelText = taskData.task.salonName; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                            if (activeSearchType === 'normal') {
                                labelText = taskData.task.serviceKeyword;
                            } else if (activeSearchType === 'special') {
                                // ç‰¹é›†ãƒšãƒ¼ã‚¸ã®å ´åˆã€åŒã˜ã‚°ãƒ©ãƒ•ã«è¤‡æ•°ã®ã‚µãƒ­ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€ã‚µãƒ­ãƒ³åã‚’è¡¨ç¤º
                                labelText = taskData.task.salonName;
                            } else if (activeSearchType === 'google') {
                                labelText = taskData.task.keyword;
                            }

                            return {
                                // ãƒ©ãƒ™ãƒ«ã‚’æ¤œç´¢ã‚¿ã‚¤ãƒ—ã«ã‚ˆã£ã¦å¤‰æ›´
                                label: labelText,
                                data: dataForChart,
                                borderColor: CHART_COLORS[index % CHART_COLORS.length],
                                tension: 0.1,
                                spanGaps: true // ãƒ‡ãƒ¼ã‚¿ãŒNaNã®å ´åˆã«ç·šã‚’é€”åˆ‡ã‚Œã•ã›ã‚‹
                            };
                        });

                        new Chart(canvas, {
                            type: 'line', data: { labels: sortedLabels, datasets },
                            options: {
                                layout: {
                                    padding: { top: 0 } // å‡¡ä¾‹ã®é«˜ã•ã«å¿œã˜ã¦è‡ªå‹•ã§ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ãŒèª¿æ•´ã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
                                },
                                maintainAspectRatio: false,
                                parsing: {
                                    xAxisKey: 'x',
                                    yAxisKey: 'y'
                                },
                                scales: {
                                    x: { // xè»¸ã®è¨­å®šã‚’è¿½åŠ 
                                        ticks: {
                                            callback: function(value, index, ticks) {
                                                const label = this.getLabelForValue(value); // 'YYYY/MM/DD'
                                                const date = new Date(label);
                                                return `${date.getMonth() + 1}/${date.getDate()}`;
                                            }
                                        }
                                    },
                                    y: {
                                        type: 'linear', // ç·šå½¢ã‚¹ã‚±ãƒ¼ãƒ«
                                        reverse: false, // Yåº§æ¨™ã¯å¤§ãã„æ–¹ãŒä¸Š
                                        min: 1.4, // åœå¤–(y=1.5)ã®ä¸‹ã®ä½™ç™½ã‚’èª¿æ•´
                                        max: 6.1, // 1ä½(y=6)ã®ä¸Šã®ä½™ç™½ã‚’ç‹­ã‚ã‚‹
                                        ticks: {
                                            callback: function(value) {
                                                switch (value) {
                                                    case 6: return '1ä½';
                                                    case 5: return '5ä½';
                                                    case 4: return '20ä½';
                                                    case 3: return '50ä½';
                                                    case 2: return '100ä½';
                                                    case 1.5: return 'åœå¤–';
                                                    default: return null;
                                                }
                                            }
                                        },
                                        afterBuildTicks: (axis) => {
                                            axis.ticks = [
                                                { value: 6 }, { value: 5 }, { value: 4 }, { value: 3 }, { value: 2 }, { value: 1.5 }
                                            ];
                                        },
                                        grid: {
                                            drawBorder: false, // è»¸ã®å¢ƒç•Œç·šã‚’éè¡¨ç¤ºã«ã™ã‚‹
                                            color: function(context) {
                                                // 'åœå¤–' (y=1) ã®ã‚°ãƒªãƒƒãƒ‰ç·šã ã‘ã‚’éè¡¨ç¤ºã«ã™ã‚‹
                                                if (context.tick.value === 1.5) {
                                                    return 'transparent';
                                                }
                                                return Chart.defaults.borderColor; // ä»–ã®ç·šã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‰²
                                            }
                                        },
                                    }
                                },
                                plugins: {
                                    legend: {
                                        position: 'top',
                                        align: 'start'
                                    },
                                    tooltip: {
                                        callbacks: {
                                            title: function(tooltipItems) {
                                                // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚‚ M/D å½¢å¼ã«ã™ã‚‹
                                                const date = new Date(tooltipItems[0].label);
                                                return `${date.getMonth() + 1}/${date.getDate()}`;
                                            },
                                            label: function(context) {
                                                const rank = context.raw.originalRank;
                                                return `${context.dataset.label}: ${rank === 'åœå¤–' ? 'åœå¤–' : rank + 'ä½'}`;
                                            }
                                        }
                                    }
                                }
                            },
                            // --- ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ  ---
                            onClick: (event, elements) => {
                                if (elements.length > 0) {
                                    const firstElement = elements[0];
                                    const datasetIndex = firstElement.datasetIndex;
                                    const dataIndex = firstElement.index;
                                    const chartData = event.chart.data.datasets[datasetIndex].data[dataIndex];
                                    
                                    const screenshotPath = chartData.screenshot;

                                    if (screenshotPath) {
                                        // æ–°ã—ã„ã‚¿ãƒ–ã§ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆç”»åƒã‚’é–‹ã
                                        window.open(screenshotPath, '_blank');
                                    } else {
                                        alert('ã“ã®è¨ˆæ¸¬ãƒ‡ãƒ¼ã‚¿ã«ã¯ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                                    }
                                }
                            }
                        });

                        // --- HPBé€šå¸¸æ¤œç´¢ã®å ´åˆã®ã¿ã€è¡¨å½¢å¼ã®å±¥æ­´ã‚‚è¡¨ç¤º ---
                        if (activeSearchType === 'normal') {
                            const tableContainer = document.createElement('div');
                            tableContainer.className = 'sticky-table-container'; // ã‚¯ãƒ©ã‚¹ã‚’é©ç”¨
                            tableContainer.style.marginTop = '20px';

                            const table = document.createElement('table');
                            table.className = 'sticky-table'; // ã‚¯ãƒ©ã‚¹ã‚’é©ç”¨
                            table.style.width = '100%';
                            table.style.borderCollapse = 'collapse';
                            table.style.fontSize = '13px';

                            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
                            const thead = document.createElement('thead');
                            const headerRow = document.createElement('tr');
                            const thKeyword = document.createElement('th');
                            thKeyword.textContent = 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰';
                            thKeyword.style.padding = '8px';
                            thKeyword.style.border = '1px solid #ddd';
                            thKeyword.style.backgroundColor = '#f8f8f8';
                            thKeyword.style.textAlign = 'left';
                            thKeyword.style.minWidth = '100px';
                            headerRow.appendChild(thKeyword);

                            sortedLabels.forEach(date => {
                                const th = document.createElement('th');
                                const d = new Date(date);
                                th.textContent = `${d.getMonth() + 1}/${d.getDate()}`;
                                th.style.padding = '8px';
                                th.style.border = '1px solid #ddd';
                                th.style.backgroundColor = '#f8f8f8';
                                th.style.minWidth = '50px';
                                headerRow.appendChild(th);
                            });
                            thead.appendChild(headerRow);
                            table.appendChild(thead);

                            // ãƒ‡ãƒ¼ã‚¿è¡Œ
                            const tbody = document.createElement('tbody');
                            groupData.forEach((taskData, rowIndex) => {
                                const dataMap = new Map(taskData.log.map(entry => [entry.date, { rank: entry.rank, screenshot: entry.screenshot }]));
                                const row = document.createElement('tr');

                                // --- ç¸æ¨¡æ§˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨ ---
                                if (rowIndex % 2 === 1) { // å¥‡æ•°è¡Œã«èƒŒæ™¯è‰²ã‚’è¨­å®š
                                    row.style.backgroundColor = '#f0f0f5'; // å›ºå®šåˆ—ã®èƒŒæ™¯è‰²ã¨åˆã‚ã›ã‚‹
                                }

                                const tdKeyword = document.createElement('td');
                                tdKeyword.textContent = taskData.task.serviceKeyword;
                                tdKeyword.style.padding = '8px';
                                tdKeyword.style.border = '1px solid #ddd';
                                tdKeyword.style.fontWeight = '500';
                                if (rowIndex % 2 === 1) tdKeyword.style.backgroundColor = '#f0f0f5';
                                row.appendChild(tdKeyword);

                                sortedLabels.forEach((date, index) => {
                                    const td = document.createElement('td');
                                    const currentEntry = dataMap.get(date);
                                    const currentRank = currentEntry ? currentEntry.rank : null;

                                    let rankHtml = currentRank !== null ? String(currentRank) : '-';

                                    // 2æ—¥ç›®ä»¥é™ã®ãƒ‡ãƒ¼ã‚¿ã§ã€ã‹ã¤å½“æ—¥ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿æ¯”è¼ƒ
                                    if (index > 0 && currentRank !== null) {
                                        const prevDate = sortedLabels[index - 1];
                                        const prevEntry = dataMap.get(prevDate);
                                        const prevRank = prevEntry ? prevEntry.rank : null;

                                        const getNumericRank = (rank) => {
                                            if (rank === null || rank === '-') return Infinity; // ãƒ‡ãƒ¼ã‚¿ãªã—
                                            if (rank === 'åœå¤–' || typeof rank !== 'number') return 101; // åœå¤–ã¯101ä½ã¨ã—ã¦æ‰±ã†
                                            return rank;
                                        };
                                        const numericCurrent = getNumericRank(currentRank);
                                        const numericPrev = getNumericRank(prevRank);

                                        if (numericPrev !== Infinity) { // å‰æ—¥ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿çŸ¢å°ã‚’è¡¨ç¤º
                                            const diff = numericPrev - numericCurrent;
                                            let color = '#1c1c1e'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‰²
                                            let fontWeight = 'normal';
                                            let arrow = '';

                                            if (diff >= 5)      { color = '#34c759'; fontWeight = 'bold'; arrow = 'â†‘'; }  // æ€¥ä¸Šæ˜‡
                                            else if (diff > 0)  { color = '#007aff'; arrow = 'â†—'; }  // ä¸Šæ˜‡
                                            else if (diff === 0)  { color = '#8e8e93'; arrow = 'â†’'; }  // æ¨ªã°ã„
                                            else if (diff > -5) { color = '#ff9500'; arrow = 'â†˜'; }  // ä¸‹é™
                                            else                { color = '#ff3b30'; fontWeight = 'bold'; arrow = 'â†“'; }  // æ€¥ä¸‹é™

                                            if (arrow) {
                                                rankHtml = `<span style="color: ${color}; font-weight: ${fontWeight};">` +
                                                           `<span style="display: inline-block; width: 1.2em; text-align: right; margin-right: 2px;">${arrow}</span>` +
                                                           `${currentRank}` +
                                                           `</span>`;
                                            }
                                        }
                                    }

                                    td.innerHTML = rankHtml;
                                    td.style.padding = '8px';
                                    td.style.border = '1px solid #ddd';
                                    td.style.textAlign = 'center';
                                    if (currentEntry && currentEntry.screenshot) {
                                        td.style.cursor = 'pointer';
                                        td.style.textDecoration = 'underline';
                                        td.onclick = () => window.open(currentEntry.screenshot, '_blank');
                                    }
                                    row.appendChild(td);
                                });
                                tbody.appendChild(row);
                            });
                            table.appendChild(tbody);
                            tableContainer.appendChild(table);
                            graphWrapper.appendChild(tableContainer);
                        }
                        // --- HPBç‰¹é›†æ¤œç´¢ã®å ´åˆã‚‚ã€è¡¨å½¢å¼ã®å±¥æ­´ã‚‚è¡¨ç¤º ---
                        else if (activeSearchType === 'special') {
                            const tableContainer = document.createElement('div');
                            tableContainer.className = 'sticky-table-container';
                            tableContainer.style.marginTop = '20px';

                            const table = document.createElement('table');
                            table.className = 'sticky-table';
                            table.style.width = '100%';
                            table.style.borderCollapse = 'collapse';
                            table.style.fontSize = '13px';

                            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
                            const thead = document.createElement('thead');
                            const headerRow = document.createElement('tr');
                            const thSalonName = document.createElement('th');
                            thSalonName.textContent = 'ã‚µãƒ­ãƒ³å'; // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å¤‰æ›´
                            thSalonName.style.padding = '8px';
                            thSalonName.style.border = '1px solid #ddd';
                            thSalonName.style.backgroundColor = '#f8f8f8';
                            thSalonName.style.textAlign = 'left';
                            thSalonName.style.minWidth = '100px';
                            headerRow.appendChild(thSalonName);

                            sortedLabels.forEach(date => {
                                const th = document.createElement('th');
                                const d = new Date(date);
                                th.textContent = `${d.getMonth() + 1}/${d.getDate()}`;
                                th.style.padding = '8px';
                                th.style.border = '1px solid #ddd';
                                th.style.backgroundColor = '#f8f8f8';
                                th.style.minWidth = '50px';
                                headerRow.appendChild(th);
                            });
                            thead.appendChild(headerRow);
                            table.appendChild(thead);

                            // ãƒ‡ãƒ¼ã‚¿è¡Œ
                            const tbody = document.createElement('tbody');
                            groupData.forEach((taskData, rowIndex) => {
                                const dataMap = new Map(taskData.log.map(entry => [entry.date, { rank: entry.rank, screenshot: entry.screenshot }]));
                                const row = document.createElement('tr');

                                if (rowIndex % 2 === 1) {
                                    row.style.backgroundColor = '#f0f0f5';
                                }

                                const tdSalonName = document.createElement('td');
                                tdSalonName.textContent = taskData.task.salonName; // è¡¨ç¤ºå†…å®¹ã‚’ã‚µãƒ­ãƒ³åã«å¤‰æ›´
                                tdSalonName.style.padding = '8px';
                                tdSalonName.style.border = '1px solid #ddd';
                                tdSalonName.style.fontWeight = '500';
                                if (rowIndex % 2 === 1) tdSalonName.style.backgroundColor = '#f0f0f5';
                                row.appendChild(tdSalonName);

                                sortedLabels.forEach((date, index) => {
                                    const td = document.createElement('td');
                                    const currentEntry = dataMap.get(date);
                                    const currentRank = currentEntry ? currentEntry.rank : null;
                                    let rankHtml = currentRank !== null ? String(currentRank) : '-';

                                    if (index > 0 && currentRank !== null) {
                                        const prevDate = sortedLabels[index - 1];
                                        const prevEntry = dataMap.get(prevDate);
                                        const prevRank = prevEntry ? prevEntry.rank : null;
                                        const getNumericRank = (rank) => (rank === null || rank === '-' || typeof rank !== 'number') ? Infinity : rank;
                                        const numericCurrent = getNumericRank(currentRank);
                                        const numericPrev = getNumericRank(prevRank);

                                        if (numericPrev !== Infinity) {
                                            const diff = numericPrev - numericCurrent;
                                            let color = '#1c1c1e', fontWeight = 'normal', arrow = '';
                                            if (diff >= 5)      { color = '#34c759'; fontWeight = 'bold'; arrow = 'â†‘'; }
                                            else if (diff > 0)  { color = '#007aff'; arrow = 'â†—'; }
                                            else if (diff === 0)  { color = '#8e8e93'; arrow = 'â†’'; }
                                            else if (diff > -5) { color = '#ff9500'; arrow = 'â†˜'; }
                                            else                { color = '#ff3b30'; fontWeight = 'bold'; arrow = 'â†“'; }

                                            if (arrow) {
                                                rankHtml = `<span style="color: ${color}; font-weight: ${fontWeight};"><span style="display: inline-block; width: 1.2em; text-align: right; margin-right: 2px;">${arrow}</span>${currentRank}</span>`;
                                            }
                                        }
                                    }

                                    td.innerHTML = rankHtml;
                                    td.style.padding = '8px';
                                    td.style.border = '1px solid #ddd';
                                    td.style.textAlign = 'center';
                                    if (currentEntry && currentEntry.screenshot) {
                                        td.style.cursor = 'pointer';
                                        td.style.textDecoration = 'underline';
                                        td.onclick = () => window.open(currentEntry.screenshot, '_blank');
                                    }
                                    row.appendChild(td);
                                });
                                tbody.appendChild(row);
                            });
                            table.appendChild(tbody);
                            tableContainer.appendChild(table);
                            graphWrapper.appendChild(tableContainer);
                        }
                        // --- MEOæ¤œç´¢ã®å ´åˆã‚‚ã€è¡¨å½¢å¼ã®å±¥æ­´ã‚‚è¡¨ç¤º ---
                        else if (activeSearchType === 'google') {
                            const tableContainer = document.createElement('div');
                            tableContainer.className = 'sticky-table-container';
                            tableContainer.style.marginTop = '20px';

                            const table = document.createElement('table');
                            table.className = 'sticky-table';
                            table.style.width = '100%';
                            table.style.borderCollapse = 'collapse';
                            table.style.fontSize = '13px';

                            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
                            const thead = document.createElement('thead');
                            const headerRow = document.createElement('tr');
                            const thKeyword = document.createElement('th');
                            thKeyword.textContent = 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰'; // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å¤‰æ›´
                            thKeyword.style.padding = '8px';
                            thKeyword.style.border = '1px solid #ddd';
                            thKeyword.style.backgroundColor = '#f8f8f8';
                            thKeyword.style.textAlign = 'left';
                            thKeyword.style.minWidth = '100px';
                            headerRow.appendChild(thKeyword);

                            sortedLabels.forEach(date => {
                                const th = document.createElement('th');
                                const d = new Date(date);
                                th.textContent = `${d.getMonth() + 1}/${d.getDate()}`;
                                th.style.padding = '8px';
                                th.style.border = '1px solid #ddd';
                                th.style.backgroundColor = '#f8f8f8';
                                th.style.minWidth = '50px';
                                headerRow.appendChild(th);
                            });
                            thead.appendChild(headerRow);
                            table.appendChild(thead);

                            // ãƒ‡ãƒ¼ã‚¿è¡Œ
                            const tbody = document.createElement('tbody');
                            groupData.forEach((taskData, rowIndex) => {
                                const dataMap = new Map(taskData.log.map(entry => [entry.date, { rank: entry.rank, screenshot: entry.screenshot }]));
                                const row = document.createElement('tr');

                                if (rowIndex % 2 === 1) {
                                    row.style.backgroundColor = '#f0f0f5';
                                }

                                const tdKeyword = document.createElement('td');
                                tdKeyword.textContent = taskData.task.keyword; // è¡¨ç¤ºå†…å®¹ã‚’ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«å¤‰æ›´
                                tdKeyword.style.padding = '8px';
                                tdKeyword.style.border = '1px solid #ddd';
                                tdKeyword.style.fontWeight = '500';
                                if (rowIndex % 2 === 1) tdKeyword.style.backgroundColor = '#f0f0f5';
                                row.appendChild(tdKeyword);

                                sortedLabels.forEach((date, index) => {
                                    const td = document.createElement('td');
                                    const currentEntry = dataMap.get(date);
                                    const currentRank = currentEntry ? currentEntry.rank : null;
                                    let rankHtml = currentRank !== null ? String(currentRank) : '-';

                                    if (index > 0 && currentRank !== null) {
                                        const prevDate = sortedLabels[index - 1];
                                        const prevEntry = dataMap.get(prevDate);
                                        const prevRank = prevEntry ? prevEntry.rank : null;
                                        const getNumericRank = (rank) => {
                                            if (rank === null || rank === '-') return Infinity;
                                            if (rank === 'åœå¤–' || typeof rank !== 'number') return 101; // åœå¤–ã¯101ä½ã¨ã—ã¦æ‰±ã†
                                            return rank;
                                        };
                                        const numericCurrent = getNumericRank(currentRank);
                                        const numericPrev = getNumericRank(prevRank);

                                        if (numericPrev !== Infinity) {
                                            const diff = numericPrev - numericCurrent;
                                            let color = '#1c1c1e', fontWeight = 'normal', arrow = '';
                                            if (diff >= 5)      { color = '#34c759'; fontWeight = 'bold'; arrow = 'â†‘'; }
                                            else if (diff > 0)  { color = '#007aff'; arrow = 'â†—'; }
                                            else if (diff === 0)  { color = '#8e8e93'; arrow = 'â†’'; }
                                            else if (diff > -5) { color = '#ff9500'; arrow = 'â†˜'; }
                                            else                { color = '#ff3b30'; fontWeight = 'bold'; arrow = 'â†“'; }

                                            if (arrow) {
                                                rankHtml = `<span style="color: ${color}; font-weight: ${fontWeight};"><span style="display: inline-block; width: 1.2em; text-align: right; margin-right: 2px;">${arrow}</span>${currentRank}</span>`;
                                            }
                                        }
                                    }

                                    td.innerHTML = rankHtml;
                                    td.style.padding = '8px';
                                    td.style.border = '1px solid #ddd';
                                    td.style.textAlign = 'center';
                                    if (currentEntry && currentEntry.screenshot) {
                                        td.style.cursor = 'pointer';
                                        td.style.textDecoration = 'underline';
                                        td.onclick = () => window.open(currentEntry.screenshot, '_blank');
                                    }
                                    row.appendChild(td);
                                });
                                tbody.appendChild(row);
                            });
                            table.appendChild(tbody);
                            tableContainer.appendChild(table);
                            graphWrapper.appendChild(tableContainer);
                        }
                    });
                } catch (error) {
                    console.error('è‡ªå‹•è¨ˆæ¸¬å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                }
            };

            // --- ã‚°ãƒ©ãƒ•ä¸¦ã³æ›¿ãˆã¨é †åºä¿å­˜ã®é–¢æ•° ---
            function moveGraph(wrapper, direction) {
                const parent = wrapper.parentNode;
                if (direction === 'up') {
                    const prevSibling = wrapper.previousElementSibling;
                    if (prevSibling) {
                        parent.insertBefore(wrapper, prevSibling);
                    }
                } else if (direction === 'down') {
                    const nextSibling = wrapper.nextElementSibling;
                    if (nextSibling) {
                        parent.insertBefore(nextSibling, wrapper);
                    }
                }
                saveGraphOrder();
            }

            function saveGraphOrder() {
                const activeSearchType = searchTypeToggle.querySelector('.toggle-button.active').dataset.type;
                const wrappers = document.querySelectorAll('#autoHistoryGraphs .graph-wrapper');
                const newOrder = Array.from(wrappers).map(w => w.dataset.groupKey);
                localStorage.setItem(`graphOrder_${activeSearchType}`, JSON.stringify(newOrder));
            }




            // --- ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚¿ã‚¹ã‚¯ä¸€è¦§ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’å¾©å…ƒ ---
            const taskListVisible = localStorage.getItem('taskListVisible');
            if (taskListVisible === 'true') {
                autoTaskListContent.style.display = 'block';
                taskListToggleIcon.style.transform = 'rotate(180deg)';
            } else {
                taskListToggleIcon.style.transform = 'rotate(0deg)';
            }
            fetchSchedule();

            // --- å°åˆ·ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
            printButton.addEventListener('click', () => {
                window.print();
            });
            fetchAutoTasks();
            fetchAndDisplayAutoHistory();
        }); // End of main DOMContentLoaded listener
    </script>
</body>
</html>